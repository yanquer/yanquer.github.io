
<!DOCTYPE HTML>
<!--
	Dopetrope 2.0 by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html data-theme="dark">
	<head>
			<title>书言</title>
			<meta http-equiv="content-type" content="text/html; charset=utf-8" />
			<meta charset="utf-8" />

			<!-- <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,900,300italic" rel="stylesheet" /> -->
			<link rel="stylesheet" href="/theme/css/custom-pygment.css" />
			<noscript>
				<link rel="stylesheet" href="/theme/css/skel-noscript.css" />
				<link rel="stylesheet" href="/theme/css/style.css" />
				<link rel="stylesheet" href="/theme/css/style-desktop.css" />
			</noscript>

		<!-- tipuesearch 放在这, 因为搜索框是全局定义的 -->
		<link rel="stylesheet" href="/theme//Tipue-Search-5.0.0/tipuesearch.css" />
		<link rel="stylesheet" href="/theme//Tipue-Search-5.0.0/custom/tipuesearch-custom.css" />
		<link rel="stylesheet" href="/theme/css/alabaster.css" />
		<link rel="stylesheet" href="/theme/css/custom-alabaster.css" />
		<!-- <link rel="stylesheet" href="/theme/fontawesome-free-6.5.1-web/css/all.min.css" /> -->
		<!--  <link rel="preload" as="font" type="font/woff2" crossorigin href="/theme/fontawesome-free-6.5.1-web/webfonts/fa-brands-400.woff2" />
		<link rel="preload" as="font" type="font/woff2" crossorigin href="/theme/fontawesome-free-6.5.1-web/webfonts/fa-regular-400.woff2" />
		<link rel="preload" as="font" type="font/woff2" crossorigin href="/theme/fontawesome-free-6.5.1-web/webfonts/fa-solid-900.woff2" />
		<link rel="preload" as="font" type="font/woff2" crossorigin href="/theme/fontawesome-free-6.5.1-web/webfonts/fa-v4compatibility.woff2" /> -->


	</head>
	<body class="no-sidebar">

		<!-- 内容 -->
		<div>

			<!-- Header Wrapper -->
			<div id="header-wrapper">
				<div class="container">
					<div class="row">
						<div class="12u">

							<!-- Header -->
								<section id="header">

									<!-- Logo -->
									<div class="page-home">
										<h1><a href="/">HOME</a></h1>
									</div>

									<!-- Nav -->
									<div class="page-menu">
										<nav id="nav">
											<ul>

												<!-- categories -->
														<li ><a href="/category/ai.html">AI</a></li>
														<li ><a href="/category/ai-yolo.html">AI, yolo</a></li>
														<li ><a href="/category/an-quan.html">安全</a></li>
														<li ><a href="/category/ban-ben-kong-zhi.html">版本控制</a></li>
														<li ><a href="/category/cao-zuo-xi-tong.html">操作系统</a></li>
														<li ><a href="/category/chang-yong-gong-ju-shi-yong.html">常用工具使用</a></li>
														<li><a href="/categories.html">More...</a></li>
											</ul>
										</nav>
									</div>
								</section>

						</div>
					</div>
					<div class="row page-head-search">
						<form class="navbar-search" action="/search.html" role="search">
							<!-- <button class="fa-solid fa-magnifying-glass" type="submit"></button> -->
							<button type="submit"></button>
							<input type="text" name="q" id="tipue_search_input" autocomplete="off" placeholder="Search...">
							<!-- <i class="fa-solid fa-magnifying-glass"></i> -->
						</form>
					</div>
  <div class="row page-head page-article persistent">
    <div class="page-head-title">
      <h2>Docker Compose</h2>
    </div>
    <div class="page-head-content">
      By
	  <a href="author/yanque.html">YanQue</a>
      , 06 March 2024
      , Category:
	  <a href="category/rong-qi-yu-ji-qun.html">容器与集群</a>
    </div>
	<div class="red-line">
    </div>
  </div>
				</div>

				<!-- 头部下方动效 -->
				<div class="waves-area">
					<section class="main-hero-waves-area waves-area">
						<svg class="waves-svg" preserveAspectRatio="none" shape-rendering="auto" viewBox="0 24 150 28"
							 xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">
							<defs>
								<path
										d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"
										id="gentle-wave"></path>
							</defs>
							<g class="parallax">
								<use href="#gentle-wave" x="48" y="0"></use>
								<use href="#gentle-wave" x="48" y="3"></use>
								<use href="#gentle-wave" x="48" y="5"></use>
								<use href="#gentle-wave" x="48" y="7"></use>
							</g>
						</svg>
					</section>
				</div>

			</div>

		<!-- Main Wrapper -->
			<div id="main-wrapper">
				<div class="container">
<div class="row">
	<div class="12u">
			<section>
				<div>
					<div class="row">
						<div class="12u skel-cell-mainContent">
							<!-- Content -->
								<article class="box is-post">
									<div class="box-head">
										<div class="post-infos">
											<ul class="tags">
												<li><a class="button" href="category/rong-qi-yu-ji-qun.html">容器与集群</a></li>
													<li><a class="button button-alt" href="tag/docker.html">Docker</a></li>

											</ul>
										</div>

										<div class="pennant pennant-alt date">2024-03-06</div>
										<h2>Docker Compose</h2>

										<span class="head-modify-time">修改于: 2024-03-06</span>

									</div>
									<div class="section" id="section-1">
<h2>简介</h2>
<p>Compose 是用于定义和运行多容器 Docker 应用程序的工具。
通过 Compose，您可以使用 YML 文件来配置应用程序需要的所有服务。
然后，使用一个命令，就可以从 YML 文件配置中创建并启动所有服务。</p>
<p>Compose 使用的三个步骤：</p>
<ol class="arabic simple">
<li>使用 Dockerfile 定义应用程序的环境。</li>
<li>使用 docker-compose.yml 定义构成应用程序的服务，这样它们可以在隔离环境中一起运行。</li>
<li>最后，执行 docker-compose up 命令来启动并运行整个应用程序。</li>
</ol>
<p>如:</p>
<pre class="literal-block">
# yaml 配置实例
version: '3'
services:
  web:
    build: .
    ports:
   - &quot;5000:5000&quot;
    volumes:
   - .:/code
    - logvolume01:/var/log
    links:
   - redis
  redis:
    image: redis
volumes:
  logvolume01: {}
</pre>
</div>
<div class="section" id="section-2">
<h2>安装</h2>
<p>可以直接去 github 下载: <a class="reference external" href="https://github.com/docker/compose/releases">https://github.com/docker/compose/releases</a></p>
<p>其实现在, 如果是桌面端, 比如MacOS, 安装的 docker 图形界面就自带 docker-compose:</p>
<pre class="literal-block">
ll /usr/local/bin/docker-compose
lrwxr-xr-x&#64; 1 yanque  admin    62B Dec  6  2022 /usr/local/bin/docker-compose -&gt; /Applications/Docker.app/Contents/Resources/bin/docker-compose
</pre>
</div>
<div class="section" id="section-3">
<h2>指令选项</h2>
<table class="docutils option-list" frame="void" rules="none">
<col class="option" />
<col class="description" />
<tbody valign="top">
<tr><td class="option-group">
<kbd><span class="option">-d</span></kbd></td>
<td>后台启动</td></tr>
<tr><td class="option-group">
<kbd><span class="option">-f</span></kbd></td>
<td><p class="first">指定配置文件, 不指定时默认为 <cite>docker-compose.yml</cite></p>
<p class="last">注意此选项要紧跟在 <cite>docker-compose</cite> 后面</p>
</td></tr>
</tbody>
</table>
<p>常用指令</p>
<div class="highlight"><pre><span></span><span class="c1"># 以当前目录下的 docker-compose.yml 文件来后台启动应用</span>
$<span class="w"> </span>docker-compose<span class="w"> </span>up<span class="w"> </span>-d
<span class="c1"># 指定当前目录下 docker-compose-me.yml 文件来后台启动应用</span>
$<span class="w"> </span>docker-compose<span class="w"> </span>-f<span class="w"> </span>docker-compose-me.yml<span class="w"> </span>up<span class="w"> </span>-d

<span class="c1"># 停止并删除所有容器</span>
$<span class="w"> </span>docker-compose<span class="w"> </span>down
<span class="c1"># 停止指定应用 appName 是需要停止的容器名</span>
$<span class="w"> </span>docker-compose<span class="w"> </span>stop<span class="w"> </span>appName
</pre></div>
</div>
<div class="section" id="section-4">
<h2>准备</h2>
<p>创建一个简单的 flask 应用:</p>
<pre class="literal-block">
$ mkdir composetest
$ cd composetest
</pre>
<p>在测试目录中创建一个名为 app.py 的文件，并复制粘贴以下内容:</p>
<pre class="literal-block">
import time

import redis
from flask import Flask

app = Flask(__name__)
cache = redis.Redis(host='redis', port=6379)


def get_hit_count():
    retries = 5
    while True:
        try:
            return cache.incr('hits')
        except redis.exceptions.ConnectionError as exc:
            if retries == 0:
                raise exc
            retries -= 1
            time.sleep(0.5)


&#64;app.route('/')
def hello():
    count = get_hit_count()
    return 'Hello World! I have been seen {} times.\n'.format(count)
</pre>
<p>在此示例中，redis 是应用程序网络上的 redis 容器的主机名，该主机使用的端口为 6379。
在 composetest 目录中创建另一个名为 requirements.txt 的文件，内容如下:</p>
<pre class="literal-block">
flask
redis
</pre>
</div>
<div class="section" id="dockerfile">
<h2>创建 dockerfile</h2>
<p>说明见 <a class="reference external" href="/yq-docs-Container-and-cluster-docker-dockerfile-writing.html">dockerfile编写</a></p>
<p>当前测试内容:</p>
<pre class="literal-block">
FROM python:3.7-alpine
WORKDIR /code
ENV FLASK_APP app.py
ENV FLASK_RUN_HOST 0.0.0.0
RUN apk add --no-cache gcc musl-dev linux-headers
COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt
COPY . .
CMD [&quot;flask&quot;, &quot;run&quot;]
</pre>
<p>解释</p>
<ul>
<li><p class="first">FROM python:3.7-alpine: 从 Python 3.7 映像开始构建镜像。</p>
</li>
<li><p class="first">WORKDIR /code: 将工作目录设置为 /code。</p>
</li>
<li><p class="first">ENV FLASK_APP app.py
ENV FLASK_RUN_HOST 0.0.0.0</p>
<p>设置 flask 命令使用的环境变量。</p>
</li>
<li><p class="first">RUN apk add --no-cache gcc musl-dev linux-headers: 安装 gcc，以便诸如 MarkupSafe 和 SQLAlchemy 之类的 Python 包可以编译加速。</p>
</li>
<li><p class="first">COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt</p>
<p>复制 requirements.txt 并安装 Python 依赖项。</p>
</li>
<li><p class="first">COPY . .: 将 . 项目中的当前目录复制到 . 镜像中的工作目录。</p>
</li>
<li><p class="first">CMD [&quot;flask&quot;, &quot;run&quot;]: 容器提供默认的执行命令为：flask run。</p>
</li>
</ul>
</div>
<div class="section" id="docker-compose-yml">
<h2>创建 docker-compose.yml</h2>
<p>在测试目录中创建一个名为 docker-compose.yml 的文件，然后粘贴以下内容:</p>
<pre class="literal-block">
# yaml 配置
version: '3'
services:
  web:
    build: .
    ports:
      - &quot;5000:5000&quot;
  redis:
    image: &quot;redis:alpine&quot;
</pre>
<p>该 Compose 文件定义了两个服务：web 和 redis。</p>
<ul class="simple">
<li>web：该 web 服务使用从 Dockerfile 当前目录中构建的镜像。然后，它将容器和主机绑定到暴露的端口 5000。此示例服务使用 Flask Web 服务器的默认端口 5000 。</li>
<li>redis：该 redis 服务使用 Docker Hub 的公共 Redis 映像。</li>
</ul>
</div>
<div class="section" id="compose">
<h2>使用 Compose 命令构建和运行您的应用</h2>
<p>在测试目录中，执行以下命令来启动应用程序:</p>
<pre class="literal-block">
docker-compose up
</pre>
<p>如果你想在后台执行该服务可以加上 -d 参数:</p>
<pre class="literal-block">
docker-compose up -d
</pre>
</div>
<div class="section" id="yml">
<h2>yml 配置指令参考</h2>
<dl class="docutils">
<dt>version</dt>
<dd>指定本 yml 依从的 compose 哪个版本制定的。</dd>
<dt>build</dt>
<dd><p class="first">指定为构建镜像上下文路径：</p>
<p>例如 webapp 服务，指定为从上下文路径 ./dir/Dockerfile 所构建的镜像:</p>
<pre class="literal-block">
version: &quot;3.7&quot;
services:
  webapp:
    build: ./dir
</pre>
<p>或者，作为具有在上下文指定的路径的对象，以及可选的 Dockerfile 和 args:</p>
<pre class="literal-block">
version: &quot;3.7&quot;
services:
  webapp:
    build:
      context: ./dir
      dockerfile: Dockerfile-alternate
      args:
        buildno: 1
      labels:
        - &quot;com.example.description=Accounting webapp&quot;
        - &quot;com.example.department=Finance&quot;
        - &quot;com.example.label-with-empty-value&quot;
      target: prod
</pre>
<ul class="last simple">
<li>context：上下文路径。</li>
<li>dockerfile：指定构建镜像的 Dockerfile 文件名。</li>
<li>args：添加构建参数，这是只能在构建过程中访问的环境变量。</li>
<li>labels：设置构建镜像的标签。</li>
<li>target：多层构建，可以指定构建哪一层。</li>
</ul>
</dd>
<dt>cap_add，cap_drop</dt>
<dd><p class="first">添加或删除容器拥有的宿主机的内核功能。</p>
<dl class="last docutils">
<dt>cap_add:</dt>
<dd><ul class="first last simple">
<li>ALL # 开启全部权限</li>
</ul>
</dd>
<dt>cap_drop:</dt>
<dd><ul class="first last simple">
<li>SYS_PTRACE # 关闭 ptrace权限</li>
</ul>
</dd>
</dl>
</dd>
<dt>cgroup_parent</dt>
<dd><p class="first">为容器指定父 cgroup 组，意味着将继承该组的资源限制:</p>
<pre class="last literal-block">
cgroup_parent: m-executor-abcd
</pre>
</dd>
<dt>command</dt>
<dd><p class="first">覆盖容器启动的默认命令:</p>
<pre class="last literal-block">
command: [&quot;bundle&quot;, &quot;exec&quot;, &quot;thin&quot;, &quot;-p&quot;, &quot;3000&quot;]
</pre>
</dd>
<dt>container_name</dt>
<dd><p class="first">指定自定义容器名称，而不是生成的默认名称:</p>
<pre class="last literal-block">
container_name: my-web-container
</pre>
</dd>
<dt>depends_on</dt>
<dd><p class="first">设置依赖关系。</p>
<ul class="simple">
<li>docker-compose up ：以依赖性顺序启动服务。在以下示例中，先启动 db 和 redis ，才会启动 web。</li>
<li>docker-compose up SERVICE ：自动包含 SERVICE 的依赖项。在以下示例中，docker-compose up web 还将创建并启动 db 和 redis。</li>
<li>docker-compose stop ：按依赖关系顺序停止服务。在以下示例中，web 在 db 和 redis 之前停止。</li>
</ul>
<p>如:</p>
<pre class="literal-block">
version: &quot;3.7&quot;
services:
  web:
    build: .
    depends_on:
      - db
      - redis
  redis:
    image: redis
  db:
    image: postgres
</pre>
<p class="last">注意：web 服务不会等待 redis db 完全启动 之后才启动。</p>
</dd>
<dt>deploy</dt>
<dd><p class="first">指定与服务的部署和运行有关的配置。只在 swarm 模式下才会有用:</p>
<pre class="last literal-block">
version: &quot;3.7&quot;
services:
  redis:
    image: redis:alpine
    deploy:
      mode：replicated
      replicas: 6
      endpoint_mode: dnsrr
      labels:
        description: &quot;This redis service label&quot;
      resources:
        limits:
          cpus: '0.50'
          memory: 50M
        reservations:
          cpus: '0.25'
          memory: 20M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
</pre>
</dd>
</dl>
<p><strong>可选参数</strong></p>
<dl class="docutils">
<dt>endpoint_mode</dt>
<dd><p class="first">访问集群服务的方式:</p>
<pre class="last literal-block">
endpoint_mode: vip
# Docker 集群服务一个对外的虚拟 ip。所有的请求都会通过这个虚拟 ip 到达集群服务内部的机器。
endpoint_mode: dnsrr
# DNS 轮询（DNSRR）。所有的请求会自动轮询获取到集群 ip 列表中的一个 ip 地址。
</pre>
</dd>
<dt>labels</dt>
<dd>在服务上设置标签。可以用容器上的 labels（跟 deploy 同级的配置） 覆盖 deploy 下的 labels。</dd>
<dt>mode：指定服务提供的模式。</dt>
<dd><ul class="first simple">
<li>replicated：复制服务，复制指定服务到集群的机器上。</li>
<li>global：全局服务，服务将部署至集群的每个节点。</li>
</ul>
<p>图解：下图中黄色的方块是 replicated 模式的运行情况，灰色方块是 global 模式的运行情况。</p>
<div class="last figure">
<img alt="as you see" src="doc-raw/resources/images/2024-03-05-16-39-09.png" style="width: 480px;" />
</div>
</dd>
<dt>replicas</dt>
<dd>mode 为 replicated 时，需要使用此参数配置具体运行的节点数量。</dd>
<dt>resources</dt>
<dd>配置服务器资源使用的限制，例如上例子，配置 redis 集群运行需要的 cpu 的百分比 和 内存的占用。避免占用资源过高出现异常。</dd>
<dt>restart_policy</dt>
<dd><p class="first">配置如何在退出容器时重新启动容器。</p>
<ul class="last simple">
<li>condition：可选 none，on-failure 或者 any（默认值：any）。</li>
<li>delay：设置多久之后重启（默认值：0）。</li>
<li>max_attempts：尝试重新启动容器的次数，超出次数，则不再尝试（默认值：一直重试）。</li>
<li>window：设置容器重启超时时间（默认值：0）。</li>
</ul>
</dd>
<dt>rollback_config</dt>
<dd><p class="first">配置在更新失败的情况下应如何回滚服务。</p>
<ul class="last simple">
<li>parallelism：一次要回滚的容器数。如果设置为0，则所有容器将同时回滚。</li>
<li>delay：每个容器组回滚之间等待的时间（默认为0s）。</li>
<li>failure_action：如果回滚失败，该怎么办。其中一个 continue 或者 pause（默认pause）。</li>
<li>monitor：每个容器更新后，持续观察是否失败了的时间 (ns|us|ms|s|m|h)（默认为0s）。</li>
<li>max_failure_ratio：在回滚期间可以容忍的故障率（默认为0）。</li>
<li>order：回滚期间的操作顺序。其中一个 stop-first（串行回滚），或者 start-first（并行回滚）（默认 stop-first ）。</li>
</ul>
</dd>
<dt>update_config</dt>
<dd><p class="first">配置应如何更新服务，对于配置滚动更新很有用。</p>
<ul class="simple">
<li>parallelism：一次更新的容器数。</li>
<li>delay：在更新一组容器之间等待的时间。</li>
<li>failure_action：如果更新失败，该怎么办。其中一个 continue，rollback 或者pause （默认：pause）。</li>
<li>monitor：每个容器更新后，持续观察是否失败了的时间 (ns|us|ms|s|m|h)（默认为0s）。</li>
<li>max_failure_ratio：在更新过程中可以容忍的故障率。</li>
<li>order：回滚期间的操作顺序。其中一个 stop-first（串行回滚），或者 start-first（并行回滚）（默认stop-first）。</li>
</ul>
<p class="last">注：仅支持 V3.4 及更高版本。</p>
</dd>
<dt>devices</dt>
<dd><p class="first">指定设备映射列表:</p>
<pre class="last literal-block">
devices:
  - &quot;/dev/ttyUSB0:/dev/ttyUSB0&quot;
</pre>
</dd>
<dt>dns</dt>
<dd><p class="first">自定义 DNS 服务器，可以是单个值或列表的多个值:</p>
<pre class="last literal-block">
dns: 8.8.8.8

dns:
  - 8.8.8.8
  - 9.9.9.9
</pre>
</dd>
<dt>dns_search</dt>
<dd><p class="first">自定义 DNS 搜索域。可以是单个值或列表:</p>
<pre class="last literal-block">
dns_search: example.com

dns_search:
  - dc1.example.com
  - dc2.example.com
</pre>
</dd>
<dt>entrypoint</dt>
<dd><p class="first">覆盖容器默认的 entrypoint:</p>
<pre class="literal-block">
entrypoint: /code/entrypoint.sh
</pre>
<p>也可以是以下格式:</p>
<pre class="last literal-block">
entrypoint:
    - php
    - -d
    - zend_extension=/usr/local/lib/php/extensions/no-debug-non-zts-20100525/xdebug.so
    - -d
    - memory_limit=-1
    - vendor/bin/phpunit
</pre>
</dd>
<dt>env_file</dt>
<dd><p class="first">从文件添加环境变量。可以是单个值或列表的多个值:</p>
<pre class="literal-block">
env_file: .env
</pre>
<p>也可以是列表格式:</p>
<pre class="last literal-block">
env_file:
  - ./common.env
  - ./apps/web.env
  - /opt/secrets.env
</pre>
</dd>
<dt>environment</dt>
<dd><p class="first">添加环境变量。您可以使用数组或字典、任何布尔值，
布尔值需要用引号引起来，以确保 YML 解析器不会将其转换为 True 或 False:</p>
<pre class="last literal-block">
environment:
  RACK_ENV: development
  SHOW: 'true'
</pre>
</dd>
<dt>expose</dt>
<dd><p class="first">暴露端口，但不映射到宿主机，只被连接的服务访问。
仅可以指定内部端口为参数:</p>
<pre class="last literal-block">
expose:
- &quot;3000&quot;
- &quot;8000&quot;
</pre>
</dd>
<dt>extra_hosts</dt>
<dd><p class="first">添加主机名映射。类似 docker client --add-host:</p>
<pre class="literal-block">
extra_hosts:
- &quot;somehost:162.242.195.82&quot;
- &quot;otherhost:50.31.209.229&quot;
</pre>
<p>以上会在此服务的内部容器中 /etc/hosts 创建一个具有 ip 地址和主机名的映射关系:</p>
<pre class="last literal-block">
162.242.195.82  somehost
50.31.209.229   otherhost
</pre>
</dd>
<dt>healthcheck::</dt>
<dd><p class="first">用于检测 docker 服务是否健康运行:</p>
<pre class="last literal-block">
healthcheck:
  test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost&quot;] # 设置检测程序
  interval: 1m30s # 设置检测间隔
  timeout: 10s # 设置检测超时时间
  retries: 3 # 设置重试次数
  start_period: 40s # 启动后，多少秒开始启动检测程序
</pre>
</dd>
<dt>image</dt>
<dd><p class="first">指定容器运行的镜像。以下格式都可以:</p>
<pre class="last literal-block">
image: redis
image: ubuntu:14.04
image: tutum/influxdb
image: example-registry.com:4000/postgresql
image: a4bc65fd # 镜像id
</pre>
</dd>
<dt>logging</dt>
<dd><p class="first">服务的日志记录配置</p>
<dl class="docutils">
<dt>driver</dt>
<dd><p class="first">指定服务容器的日志记录驱动程序，默认值为json-file。有以下三个选项</p>
<ul class="last simple">
<li>driver: &quot;json-file&quot;</li>
<li>driver: &quot;syslog&quot;</li>
<li>driver: &quot;none&quot;</li>
</ul>
</dd>
</dl>
<p>仅在 json-file 驱动程序下，可以使用以下参数，限制日志得数量和大小:</p>
<pre class="literal-block">
logging:
  driver: json-file
  options:
    max-size: &quot;200k&quot; # 单个文件大小为200k
    max-file: &quot;10&quot; # 最多10个文件
</pre>
<p>当达到文件限制上限，会自动删除旧得文件。</p>
<p>syslog 驱动程序下，可以使用 syslog-address 指定日志接收地址:</p>
<pre class="last literal-block">
logging:
  driver: syslog
  options:
    syslog-address: &quot;tcp://192.168.0.42:123&quot;
</pre>
</dd>
<dt>network_mode</dt>
<dd><p class="first">设置网络模式:</p>
<pre class="literal-block">
network_mode: &quot;bridge&quot;
network_mode: &quot;host&quot;
network_mode: &quot;none&quot;
network_mode: &quot;service:[service name]&quot;
network_mode: &quot;container:[container name/id]&quot;
</pre>
<p>networks
配置容器连接的网络，引用顶级 networks 下的条目</p>
<pre class="literal-block">
services:
  some-service:
    networks:
      some-network:
        aliases:
        - alias1
      other-network:
        aliases:
        - alias2
networks:
  some-network:
    # Use a custom driver
    driver: custom-driver-1
  other-network:
    # Use a custom driver which takes special options
    driver: custom-driver-2
</pre>
<p class="last">aliases ：同一网络上的其他容器可以使用服务名称或此别名来连接到对应容器的服务。</p>
</dd>
<dt>restart</dt>
<dd><ul class="first simple">
<li>no：是默认的重启策略，在任何情况下都不会重启容器。</li>
<li>always：容器总是重新启动。</li>
<li>on-failure：在容器非正常退出时（退出状态非0），才会重启容器。</li>
<li>unless-stopped：在容器退出时总是重启容器，但是不考虑在Docker守护进程启动时就已经停止了的容器</li>
</ul>
<p>如:</p>
<pre class="literal-block">
restart: &quot;no&quot;
restart: always
restart: on-failure
restart: unless-stopped
</pre>
<p class="last">注：swarm 集群模式，请改用 restart_policy。</p>
</dd>
<dt>secrets</dt>
<dd><p class="first">存储敏感数据，例如密码:</p>
<pre class="last literal-block">
version: &quot;3.1&quot;
services:

mysql:
  image: mysql
  environment:
    MYSQL_ROOT_PASSWORD_FILE: /run/secrets/my_secret
  secrets:
    - my_secret

secrets:
  my_secret:
    file: ./my_secret.txt
</pre>
</dd>
<dt>security_opt</dt>
<dd><p class="first">修改容器默认的 schema 标签:</p>
<pre class="last literal-block">
security-opt：
  - label:user:USER   # 设置容器的用户标签
  - label:role:ROLE   # 设置容器的角色标签
  - label:type:TYPE   # 设置容器的安全策略标签
  - label:level:LEVEL  # 设置容器的安全等级标签
</pre>
</dd>
<dt>stop_grace_period</dt>
<dd><p class="first">指定在容器无法处理 SIGTERM (或者任何 stop_signal 的信号)，等待多久后发送 SIGKILL 信号关闭容器:</p>
<pre class="literal-block">
stop_grace_period: 1s # 等待 1 秒
stop_grace_period: 1m30s # 等待 1 分 30 秒
</pre>
<p class="last">默认的等待时间是 10 秒。</p>
</dd>
<dt>stop_signal</dt>
<dd><p class="first">设置停止容器的替代信号。默认情况下使用 SIGTERM 。
以下示例，使用 SIGUSR1 替代信号 SIGTERM 来停止容器:</p>
<pre class="last literal-block">
stop_signal: SIGUSR1
</pre>
</dd>
<dt>sysctls</dt>
<dd><p class="first">设置容器中的内核参数，可以使用数组或字典格式:</p>
<pre class="last literal-block">
sysctls:
  net.core.somaxconn: 1024
  net.ipv4.tcp_syncookies: 0

sysctls:
  - net.core.somaxconn=1024
  - net.ipv4.tcp_syncookies=0
</pre>
</dd>
<dt>tmpfs</dt>
<dd><p class="first">在容器内安装一个临时文件系统。可以是单个值或列表的多个值:</p>
<pre class="last literal-block">
tmpfs: /run

tmpfs:
  - /run
  - /tmp
</pre>
</dd>
<dt>ulimits</dt>
<dd><p class="first">覆盖容器默认的 ulimit:</p>
<pre class="last literal-block">
ulimits:
  nproc: 65535
  nofile:
    soft: 20000
    hard: 40000
</pre>
</dd>
<dt>volumes</dt>
<dd><p class="first">将主机的数据卷或着文件挂载到容器里:</p>
<pre class="last literal-block">
version: &quot;3.7&quot;
services:
  db:
    image: postgres:latest
    volumes:
      - &quot;/localhost/postgres.sock:/var/run/postgres/postgres.sock&quot;
      - &quot;/localhost/data:/var/lib/postgresql/data&quot;
</pre>
</dd>
</dl>
<p>参考: <a class="reference external" href="https://www.runoob.com/docker/docker-compose.html">菜鸟教程</a></p>
</div>
<div class="section" id="yml-1">
<h2>yml文件存在多行配置</h2>
<p>使用 &quot;|&quot; 表示是多行配置</p>
<p>如</p>
<div class="highlight"><pre><span></span>environment:
  TZ: &#39;Asia/Shanghai&#39;
  # | 表示下面配置是多行配置
  GITLAB_OMNIBUS_CONFIG: |
    nginx[&#39;listen_addresses&#39;] = [&#39;127.0.0.1&#39;,&#39;*&#39;, &#39;[::]&#39;]
    # 开启 https
    nginx[&#39;listen_port&#39;] = 443
    external_url  &#39;https://192.168.1.108:8443&#39;
    nginx[&#39;redirect_http_to_https&#39;] = true
    # 将 80 端口的转发到 external_url/url
    nginx[&#39;redirect_http_to_https_port&#39;] = 80
</pre></div>
</div>

								</article>
						</div>
					</div>
				</div>
			</section>
	</div>
</div>

				</div>
			</div>



		<!-- Sider Bar -->
		<div id="right-side-bar">
	<nav>
		<div id="top-toc-tree-container" class="fixed-container">
			<div class="toc-contents-title">
				<h4 id="toc-contents-title-text">Contents</h4>
				<!-- <span class="tool-tip-text">点击隐藏</span> -->
			</div>
			<div id="toc-tree-container">
 <ul class="toc-tree visible">
  <li class="toc-h0">
   <a class="" href="#section-1">
    简介
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#section-2">
    安装
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#section-3">
    指令选项
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#section-4">
    准备
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#dockerfile">
    创建 dockerfile
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#docker-compose-yml">
    创建 docker-compose.yml
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#compose">
    使用 Compose 命令构建和运行您的应用
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#yml">
    yml 配置指令参考
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#yml-1">
    yml文件存在多行配置
   </a>
  </li>
 </ul>
</div>

		</div>
	</nav>
	<div id="sidebar-tools" class="fixed-container no-active cant-select">
		<!-- 按钮 使用 content 绘制图标 -->
	</div>
	<div id="sidebar-tool-back-top" class="fixed-container cant-select">
		<!-- 按钮 使用 content 绘制图标 -->
	</div>
		</div>

		<!-- Footer Wrapper -->
			<div id="footer-wrapper">
				<!-- Footer -->
					<section id="footer" class="container">
						<div class="row">
							<div class="8u">
								<section>
									<header>
										<h2>Latest articles</h2>
									</header>
									<ul class="dates">
										<li>
											<span class="date">Feb <strong>25</strong></span>
											<h3><a href="yq-docs-AI-Computer-vision-picture-mark-util.html">图片标注工具</a></h3>
											<p><p class="first last">图片标注工具</p>
</p>
										</li>
										<li>
											<span class="date">Feb <strong>25</strong></span>
											<h3><a href="yq-docs-document-markdown-insert-asset-file.html">markdown插入资源文件</a></h3>
											<p><p class="first last">markdown插入资源文件</p>
</p>
										</li>
										<li>
											<span class="date">Feb <strong>25</strong></span>
											<h3><a href="yq-docs-front-end-frame-webpack-issue-compilation-error.html">Webpack编译报错整理</a></h3>
											<p><p class="first last">Webpack编译报错整理</p>
</p>
										</li>
										<li>
											<span class="date">Feb <strong>25</strong></span>
											<h3><a href="yq-docs-front-end-frame-webpack-issue-index.html">webpack问题</a></h3>
											<p><p class="first last">webpack问题</p>
</p>
										</li>
									</ul>
								</section>
							</div>
						</div>
						<div class="row">
							<div class="4u">
								<section>
									<header>
										<h2>Blogroll</h2>
									</header>
									<ul class="divided">
											<li><a href="https://yq-yqr.readthedocs.io/zh/blog-theme/blog.html">旧版(迁移中)</a></li>
											<li><a href="https://getpelican.com/">Pelican</a></li>
											<li><a href="https://www.python.org/">Python.org</a></li>
											<li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
									</ul>
								</section>
							</div>
							<div class="4u">
								<section>
									<header>
										<h2>Categories</h2>
									</header>
									<ul class="divided">
											<li><a href="/category/ai.html">AI</a></li>
											<li><a href="/category/ai-yolo.html">AI, yolo</a></li>
											<li><a href="/category/an-quan.html">安全</a></li>
											<li><a href="/category/ban-ben-kong-zhi.html">版本控制</a></li>
									</ul>
								</section>
							</div>

							<div class="4u">
								<section>
									<header>
										<h2>SITEMAP</h2>
									</header>

									<ul class="divided">
												<li><a href="/authors.html">作者</a></li>
												<li><a href="/categories.html">分类</a></li>
												<li><a href="/archives.html">归档</a></li>
												<li><a href="/tags.html">标签</a></li>
									</ul>
								</section>
							</div>

							<div class="4u">

								<section>
									<header>
										<h2>Contact</h2>
									</header>
									<ul class="social">
									</ul>
								</section>
							</div>
						</div>
						<div class="row">
							<div class="12u">
								<!-- Copyright -->
									<div id="copyright">
										<ul class="links">
											<li>&copy; YanQue 2019-2024	</li>
											<!-- <li>Images: <a href="http://facebook.com/DreametryDoodle">Dreametry Doodle</a> + <a href="http://iconify.it">Iconify.it</a></li>
											<li>Design: <a href="http://html5up.net">HTML5 UP</a></li> -->
										</ul>
									</div>
							</div>
						</div>
					</section>
			</div>

		</div>

		<!-- 其他 -->

			<div style="position: fixed;">
				<!-- 深色模式粒子效果 -->
				<!-- <canvas id="universe" width="1428" height="993" data-relingo-block="true" data-relingo-parsed="true"></canvas> -->
				<!-- 深色模式下添加粒子效果canvas -->
				<canvas id="universe" width="1312" height="880"></canvas>
			</div>

		<script src="/theme/js/jquery-3.7.1.min.js"></script>
		<script src="/theme/js/jquery.dropotron.js"></script>
		<script src="/theme/js/config.js"></script>
		<script src="/theme/skel-s0.4.8/skel.min.js"></script>
		<script src="/theme/skel-s0.4.8/skel-panels.min.js"></script>
		<!-- <script src="/theme/js/skel.min.js"></script>
		<script src="/theme/js/skel-panels.min.js"></script> -->
		<script src="/theme/js/backloading.js"></script>
		<script src="/theme/js/canvas/dark.js"></script>
		<script src="/theme/js/yq-blog-plugin.min.js"></script>
<script type="text/javascript">
	function addEvent() {
		$("#toc-contents-title-text").click(function() {
			$("#top-toc-tree-container").toggleClass("no-active");
			$("#sidebar-tools").toggleClass("no-active");
		})
		$("#sidebar-tools").click(function() {
			$("#top-toc-tree-container").toggleClass("no-active");
			$("#sidebar-tools").toggleClass("no-active");
		})
		$("#sidebar-tool-back-top").click(function() {
			// window.scrollTo(0, 0);
			window.scrollTo({
				top: 0,
				left: 0,
				behavior: 'smooth'
			});
		})
	}
	addEvent()
</script>
		<!--[if lte IE 8]><script src="js/html5shiv.js"></script><link rel="stylesheet" href="/theme/css/ie8.css" /><![endif]-->
	</body>
</html>