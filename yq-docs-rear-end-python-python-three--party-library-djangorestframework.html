
<!DOCTYPE HTML>
<!--
	Dopetrope 2.0 by HTML5 UP
	html5up.net | @n33co
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html data-theme="dark">
	<head>
			<title>书言</title>
			<meta http-equiv="content-type" content="text/html; charset=utf-8" />
			<meta charset="utf-8" />
			<link rel="icon" href="/favicon.ico" type="image/x-icon">

			<!-- <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,900,300italic" rel="stylesheet" /> -->
			<link rel="stylesheet" href="/theme//css/custom-pygment.css" />
			<noscript>
				<link rel="stylesheet" href="/theme//css/skel-noscript.css" />
				<link rel="stylesheet" href="/theme//css/style.css" />
				<link rel="stylesheet" href="/theme//css/style-desktop.css" />
			</noscript>

		<!-- tipuesearch 放在这, 因为搜索框是全局定义的 -->
		<link rel="stylesheet" href="/theme//Tipue-Search-5.0.0/tipuesearch.css" />
		<link rel="stylesheet" href="/theme//Tipue-Search-5.0.0/custom/tipuesearch-custom.css" />
		<link rel="stylesheet" href="/theme//css/alabaster.css" />
		<link rel="stylesheet" href="/theme//css/custom-alabaster.css" />
		<!-- <link rel="stylesheet" href="/theme/fontawesome-free-6.5.1-web/css/all.min.css" /> -->
		<!--  <link rel="preload" as="font" type="font/woff2" crossorigin href="/theme/fontawesome-free-6.5.1-web/webfonts/fa-brands-400.woff2" />
		<link rel="preload" as="font" type="font/woff2" crossorigin href="/theme/fontawesome-free-6.5.1-web/webfonts/fa-regular-400.woff2" />
		<link rel="preload" as="font" type="font/woff2" crossorigin href="/theme/fontawesome-free-6.5.1-web/webfonts/fa-solid-900.woff2" />
		<link rel="preload" as="font" type="font/woff2" crossorigin href="/theme/fontawesome-free-6.5.1-web/webfonts/fa-v4compatibility.woff2" /> -->


	</head>
	<body class="no-sidebar">

		<!-- 内容 -->
		<div>

			<!-- Header Wrapper -->
			<div id="header-wrapper">
				<div class="container">
					<div class="row">
						<div class="12u">

							<!-- Header -->
								<section id="header">

									<!-- Logo -->
									<div class="page-home">
										<h1><a href="/">HOME</a></h1>
									</div>

									<!-- Nav -->
									<div class="page-menu">
										<nav id="nav">
											<ul>

												<!-- categories -->
														<li ><a href="/category/ai.html">AI</a></li>
														<li ><a href="/category/ai-yolo.html">AI, yolo</a></li>
														<li ><a href="/category/an-quan.html">安全</a></li>
														<li ><a href="/category/ban-ben-kong-zhi.html">版本控制</a></li>
														<li ><a href="/category/cao-zuo-xi-tong.html">操作系统</a></li>
														<li ><a href="/category/chang-yong-gong-ju-shi-yong.html">常用工具使用</a></li>
														<li><a href="/categories.html">More...</a></li>
											</ul>
										</nav>
									</div>
								</section>

						</div>
					</div>
					<div class="row page-head-search">
						<form class="navbar-search" action="/search.html" role="search">
							<!-- <button class="fa-solid fa-magnifying-glass" type="submit"></button> -->
							<button type="submit"></button>
							<input type="text" name="q" id="tipue_search_input" autocomplete="off" placeholder="Search...">
							<!-- <i class="fa-solid fa-magnifying-glass"></i> -->
						</form>
					</div>
  <div class="row page-head page-article persistent">
    <div class="page-head-title">
      <h2>djangorestframework</h2>
    </div>
    <div class="page-head-content">
      By
	  <a href="author/yanque.html">YanQue</a>
      , 26 December 2024
      , Category:
	  <a href="category/hou-duan-python.html">后端; python</a>
    </div>
	<div class="red-line">
    </div>
  </div>
				</div>

				<!-- 头部下方动效 -->
				<div class="waves-area">
					<section class="main-hero-waves-area waves-area">
						<svg class="waves-svg" preserveAspectRatio="none" shape-rendering="auto" viewBox="0 24 150 28"
							 xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg">
							<defs>
								<path
										d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"
										id="gentle-wave"></path>
							</defs>
							<g class="parallax">
								<use href="#gentle-wave" x="48" y="0"></use>
								<use href="#gentle-wave" x="48" y="3"></use>
								<use href="#gentle-wave" x="48" y="5"></use>
								<use href="#gentle-wave" x="48" y="7"></use>
							</g>
						</svg>
					</section>
				</div>

			</div>

		<!-- Main Wrapper -->
			<div id="main-wrapper">
				<div class="container">
<div class="row">
	<div class="12u">
			<section>
				<div>
					<div class="row">
						<div class="12u skel-cell-mainContent">
							<!-- Content -->
								<article class="box is-post">
									<div class="box-head">
										<div class="post-infos">
											<ul class="tags">
												<li><a class="button" href="category/hou-duan-python.html">后端; python</a></li>
													<li><a class="button button-alt" href="tag/python.html">Python</a></li>

													<li><a class="button button-alt" href="tag/pythonsan-fang-ku.html">Python三方库</a></li>

											</ul>
										</div>

										<div class="pennant pennant-alt date">2024-12-26</div>
										<h2>djangorestframework</h2>

										<span class="head-modify-time">修改于: 2024-12-26</span>

									</div>
									<dl class="docutils">
<dt>相关资源</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="https://www.django-rest-framework.org/#development">官网</a></li>
</ul>
</dd>
<dt>参考</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="https://segmentfault.com/a/1190000004400863">思否 - Django REST framework的各种技巧——5.搜索</a></li>
<li><a class="reference external" href="https://www.cnblogs.com/clwsec/p/15684798.html">博客园 - DjangoRestFramework使用总结</a></li>
</ul>
</dd>
</dl>
<p>安装:</p>
<pre class="literal-block">
pip install djangorestframework
pip install markdown       # Markdown support for the browsable API.
pip install django-filter  # Filtering support
</pre>
<p>设置文件中的 <cite>INSTALLED_APPS</cite> 增加 'rest_framework'</p>
<pre class="literal-block">
INSTALLED_APPS = [
    ...
    'rest_framework',
]
</pre>
<p>以及配置 <cite>REST_FRAMEWORK</cite> , <cite>DEFAULT_PERMISSION_CLASSES</cite> 表示接口权限如何控制,
可以在 <cite>viewset</cite> 中更细粒度控制</p>
<pre class="literal-block">
# reset
REST_FRAMEWORK = {
    # Use Django's standard `django.contrib.auth` permissions,
    # or allow read-only access for unauthenticated users.
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.DjangoModelPermissionsOrAnonReadOnly'
    ]
}
</pre>
<div class="section" id="section-1">
<h2>配置相关</h2>
<div class="section" id="section-2">
<h3>认证方式配置</h3>
<p>可以在配置文件中配置全局默认的认证方案</p>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.authentication.BasicAuthentication&#39;</span><span class="p">,</span>   <span class="c1"># 基本表单认证</span>
        <span class="s1">&#39;rest_framework.authentication.SessionAuthentication&#39;</span><span class="p">,</span>  <span class="c1"># session认证</span>
    <span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>也可以在视图中通过设置 <cite>authentication_classess</cite> 属性来设置</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">SessionAuthentication</span><span class="p">,</span> <span class="n">BasicAuthentication</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="k">class</span> <span class="nc">ExampleView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">SessionAuthentication</span><span class="p">,</span> <span class="n">BasicAuthentication</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
<p>认证失败会有两种可能的返回值：</p>
<ul class="simple">
<li>401 Unauthorized 未认证</li>
<li>403 Permission Denied 权限被禁止</li>
</ul>
<div class="section" id="section-3">
<h4>自定义认证类</h4>
<p>可以自定义认证类, 需要继承 <cite>rest_framework.authentication.BaseAuthentication</cite> 类
并实现 <cite>authenticate</cite> 方法, 该方法返回一个元组, 包含用户和认证信息.</p>
<ul class="simple">
<li>如果认证失败, 返回 <cite>None</cite> , 认证成功返回一个元组, 包含用户和认证信息.</li>
<li>如果认证成功, 该方法会返回一个元组, 包含用户和认证信息.</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.authentication</span> <span class="kn">import</span> <span class="n">BaseAuthentication</span>

<span class="k">class</span> <span class="nc">TestAuthentication</span><span class="p">(</span><span class="n">BaseAuthentication</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="section-4">
<h3>权限配置</h3>
<p>可以在配置文件中配置全局默认的权限方案</p>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;rest_framework.permissions.IsAuthenticated&#39;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>如果未指明，则采用如下默认配置</p>
<div class="highlight"><pre><span></span><span class="s1">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
  <span class="s1">&#39;rest_framework.permissions.AllowAny&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
<p>也可以在具体的视图中通过permission_classes属性来设置，如</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">IsAuthenticated</span>
<span class="kn">from</span> <span class="nn">rest_framework.viewsets</span> <span class="kn">import</span> <span class="n">ModelViewSet</span>

<span class="n">BooksModelViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticated</span><span class="p">,)</span> <span class="c1">#登录授权用户</span>
    <span class="o">...</span>
</pre></div>
<p><cite>rest_framework.permissions</cite> 预定义权限</p>
<ul class="simple">
<li>AllowAny 允许所有用户</li>
<li>IsAuthenticated 仅通过认证的用户</li>
<li>IsAdminUser 仅管理员用户</li>
<li>IsAuthenticatedOrReadOnly 认证的用户可以完全操作，否则只能get读取</li>
<li>DjangoModelPermissions等</li>
</ul>
<div class="section" id="section-5">
<h4>自定义权限控制类</h4>
<p>可以自定义权限控制类, 需要继承 <cite>rest_framework.permissions.BasePermission</cite> 类</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.permissions</span> <span class="kn">import</span> <span class="n">BasePermission</span>

<span class="k">class</span> <span class="nc">TestPermission</span><span class="p">(</span><span class="n">BasePermission</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return `True` if permission is granted, `False` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return `True` if permission is granted, `False` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="section" id="section-6">
<h3>限流</h3>
<p>对接口访问的频次进行限制，以减轻服务器压力，主要用于反爬虫。</p>
<p>可以在配置文件中配置全局默认的限流方案, 使用 <cite>DEFAULT_THROTTLE_CLASSES</cite> 和 <cite>DEFAULT_THROTTLE_RATES</cite> 进行全局配置，</p>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_THROTTLE_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.throttling.AnonRateThrottle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rest_framework.throttling.UserRateThrottle&#39;</span>
    <span class="p">),</span>
    <span class="c1">#DEFAULT_THROTTLE_RATES 可以使用 second, minute, hour 或day来指明周期。</span>
    <span class="s1">&#39;DEFAULT_THROTTLE_RATES&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;anon&#39;</span><span class="p">:</span> <span class="s1">&#39;5/day&#39;</span><span class="p">,</span> <span class="c1"># 匿名用户每天访问5次</span>
        <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;100/day&#39;</span>  <span class="c1"># 登录用户访问100次</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>也可以在具体视图中通过throttle_classes属性来配置，如</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.throttling</span> <span class="kn">import</span> <span class="n">UserRateThrottle</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>

<span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="n">throttle_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">UserRateThrottle</span><span class="p">,)</span>
    <span class="o">...</span>
</pre></div>
<div class="section" id="section-7">
<h4>自定义限流类</h4>
<p>可以自定义限流类, 一般继承 <cite>rest_framework.throttling.BaseThrottle</cite> 类
并实现 <cite>allow_request</cite> 和 <cite>wait</cite> 方法</p>
<ul class="simple">
<li><cite>allow_request</cite> 方法返回 <cite>True</cite> 或 <cite>False</cite>, 表示是否允许请求</li>
<li><cite>wait</cite> 方法返回等待时间, 单位为秒</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.throttling</span> <span class="kn">import</span> <span class="n">BaseThrottle</span><span class="p">,</span> <span class="n">SimpleRateThrottle</span>

<span class="k">class</span> <span class="nc">TestThrottle</span><span class="p">(</span><span class="n">SimpleRateThrottle</span><span class="p">)</span>

    <span class="n">scope</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>

    <span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ident</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_format</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
            <span class="s1">&#39;ident&#39;</span><span class="p">:</span> <span class="n">ident</span>
        <span class="p">}</span>

<span class="c1"># 一般继承SimpleRateThrottle，而不是BaseThrottle</span>
<span class="k">class</span> <span class="nc">BaseThrottle</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rate throttling of requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">allow_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return `True` if the request should be allowed, `False` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;.allow_request() must be overridden&#39;</span><span class="p">)</span>
</pre></div>
<p>其它 <cite>rest_framework.throttling</cite> 预定义的限流类</p>
<ul class="simple">
<li><cite>AnonRateThrottle</cite> - 匿名用户限流, 使用IP区分用户, 使用 <cite>DEFAULT_THROTTLE_RATES['anon']</cite> 来设置频次</li>
<li><cite>UserRateThrottle</cite> - 登录用户限流, 使用 <cite>User id</cite> 来区分, 使用 <cite>DEFAULT_THROTTLE_RATES['user']</cite> 来设置频次</li>
<li><cite>ScopedRateThrottle</cite> - 作用域限流, 限制用户对于每个视图的访问频次，使用 <cite>ip</cite> 或 <cite>user id</cite> 来区分用户, 使用 <cite>DEFAULT_THROTTLE_RATES['&lt;scope&gt;']</cite> 来设置频次</li>
</ul>
</div>
</div>
<div class="section" id="section-8">
<h3>多版本接口</h3>
<p><cite>rest_framework.versioning</cite> 模块定义了 <cite>VersioningMixin</cite> 类，它提供了许多方法来确定请求的版本，并使用这些方法来确定应该使用哪个视图集。</p>
<p>在给外部提供的API中，可会存在多个版本，为了区分不同版本，django rest framework提供了4种版本类供我们选择。</p>
<dl class="docutils">
<dt>QueryParameterVersioning</dt>
<dd>在url中传递版本，如： <cite>http://www.example.com/api?version=v1</cite></dd>
<dt>URLPathVersioning</dt>
<dd>在url路径传递版本，如： <cite>http://www.example.com/api/v1</cite></dd>
<dt>AcceptHeaderVersioning</dt>
<dd><p class="first">在请求头的Accept中传递版本，如:</p>
<pre class="last literal-block">
GET /something/ HTTP/1.1
Host: example.com
# 指定version
Accept: application/json; version=1.0
</pre>
</dd>
<dt>NamespaceVersioning</dt>
<dd><p class="first">后端 <cite>定义url</cite> 处指定 <cite>namespace</cite> 用于区分版本，对使用者而言类似URLPathVersioning:</p>
<pre class="last literal-block">
# 使用namespace指定版本
urlpatterns = [
        url(r'^v1/', include('users.urls', namespace='v1')),
        url(r'^v2/', include('users.urls', namespace='v2'))
    ]
</pre>
</dd>
</dl>
<p>多版本接口在配置文件中全局配置</p>
<div class="highlight"><pre><span></span><span class="c1"># REST_FRAMEWORK = {</span>
<span class="c1">#     &#39;DEFAULT_VERSIONING_CLASS&#39;: &#39;rest_framework.versioning.QueryParameterVersioning&#39;,</span>
<span class="c1">#     &#39;ALLOWED_VERSIONS&#39;: [&#39;v1&#39;, &#39;v2&#39;],</span>
<span class="c1">#     &#39;VERSION_PARAM&#39;: &#39;version&#39;,</span>
<span class="c1">#     &#39;VERSION&#39;: &#39;v1&#39;</span>
<span class="c1"># }</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># 版本控制</span>
    <span class="s2">&quot;DEFAULT_VERSIONING_CLASS&quot;</span><span class="p">:</span> <span class="s1">&#39;rest_framework.versioning.URLPathVersioning&#39;</span><span class="p">,</span>
    <span class="s2">&quot;ALLOWED_VERSIONS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">,</span> <span class="s2">&quot;v2&quot;</span><span class="p">]</span><span class="err">，</span>
    <span class="s2">&quot;DEFAULT_VERSION&quot;</span><span class="p">:</span> <span class="s2">&quot;v1&quot;</span>
    <span class="s2">&quot;VERSION_PARAM&quot;</span><span class="p">:</span> <span class="s2">&quot;version&quot;</span>
<span class="p">}</span>
</pre></div>
<p>也可以在视图中指定</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ExampleView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
  <span class="n">versioning_class</span> <span class="o">=</span> <span class="s2">&quot;v1&quot;</span>
</pre></div>
<p>然后在url中编写相对应的url即可。</p>
<div class="section" id="section-9">
<h4>自定义版本控制类</h4>
<ul class="simple">
<li>继承 <cite>BaseVersioning</cite> 类，重写 <cite>determine_version(self, request, *args, **kwargs)</cite> 方法</li>
<li>一般直接使用内置的类，不需要自己写</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.versioning</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BaseVersioning</span><span class="p">,</span>
    <span class="n">QueryParameterVersioning</span><span class="p">,</span>
    <span class="n">URLPathVersioning</span>
<span class="p">)</span>
<span class="c1"># 一般直接使用内置的类，不需要自己写</span>

<span class="k">class</span> <span class="nc">TestVersion</span><span class="p">(</span><span class="n">BaseVersioning</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    自定义的version,通过get参数传参</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">determine_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">version</span>
</pre></div>
<ul class="simple">
<li>需要注意的是：在view中会返回request.version，用于获取版本；request.versioning_scheme：获取版本的对象。</li>
<li>reverse：反向生成url，需要定义url中的name（如需反向生成url，则重写reverse函数）</li>
</ul>
</div>
</div>
<div class="section" id="section-10">
<h3>过滤/搜索</h3>
<p>对于列表数据可能需要根据字段进行过滤。</p>
<p>可以通过添加 <cite>django-fitlter</cite> 扩展来增强支持， 但过滤的视图应要求是实现了 <cite>ListModelMixin</cite> 扩展类及其子类的视图:</p>
<pre class="literal-block">
pip install django-filter
</pre>
<p>在配置文件中增加全局配置</p>
<div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="s1">&#39;django_filters&#39;</span><span class="p">,</span>  <span class="c1"># 需要注册应用，</span>
<span class="p">]</span>

<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_FILTER_BACKENDS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;django_filters.rest_framework.DjangoFilterBackend&#39;</span><span class="p">,)</span>
<span class="p">}</span>
</pre></div>
<p>在视图中添加 <cite>filterset_fields</cite> 属性，指定可以过滤的字段</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BookListViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">filterset_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">)</span>
</pre></div>
<div class="section" id="section-11">
<h4>自定义过滤类</h4>
<ul class="simple">
<li>继承 <cite>BaseFilterBackend</cite> 类，重写 <cite>filter_queryset(self, request, queryset, view)</cite> 方法</li>
<li>返回queryset</li>
</ul>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.filters</span> <span class="kn">import</span> <span class="n">BaseFilterBackend</span>
<span class="kn">from</span> <span class="nn">django_filters.rest_framework</span> <span class="kn">import</span> <span class="n">DjangoFilterBackend</span>

<span class="k">class</span> <span class="nc">MyBaseFilterBackend</span><span class="p">(</span><span class="n">BaseFilterBackend</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">view</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a filtered queryset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">queryset</span>
</pre></div>
<p><cite>BaseFilterBackend</cite> 定义在 <cite>rest_framework.filters</cite> 中，另外。
通常使用 <cite>django_filters.rest_framework</cite> 中的 <cite>DjangoFilterBackend</cite> 类作为基础过滤类，支持 <cite>REST framework</cite> 高度自定义字段过滤。</p>
</div>
<div class="section" id="orderingfilter">
<h4>排序OrderingFilter</h4>
<p>对于列表数据， <cite>REST framework</cite> 提供了 <cite>OrderingFilter</cite> 过滤器来按照指定字段进行排序。
同样要实现 <cite>ListModelMixin</cite> 扩展类及子类的视图才能使用。</p>
<dl class="docutils">
<dt>ordering_fields配置</dt>
<dd><p class="first">在类视图中设置 <cite>filter_backends</cite> ，
使用 <cite>rest_framework.filters.OrderingFilter</cite> 过滤器，
<cite>REST framework</cite> 会在请求的查询字符串参数中检查是否包含了 <cite>ordering</cite> 参数，
如果包含了 <cite>ordering</cite> 参数，则按照 <cite>ordering</cite> 参数指明的排序字段对数据集进行排序。</p>
<div class="last"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BookListViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrderingFilter</span><span class="p">]</span>
    <span class="n">ordering_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;bread&#39;</span><span class="p">,</span> <span class="s1">&#39;bpub_date&#39;</span><span class="p">)</span>
</pre></div>
</div></dd>
<dt>ordering在url如何调用</dt>
<dd><p class="first">默认情况下，查询参数被命名为 <cite>'ordering'</cite> ，但这可能会被 <cite>ORDERING_PARAM</cite> 设置覆盖。</p>
<p>例如，要按 username 对用户排序:</p>
<pre class="last literal-block">
# 正序
http://example.com/api/users?ordering=username
# 倒序
http://example.com/api/users?ordering=-username
# 多个字段排序，用逗号隔开
http://example.com/api/users?ordering=account,username
</pre>
</dd>
<dt>排序原则</dt>
<dd><p class="first">如果在视图上未指定 <cite>ordering_fields</cite> 属性，
则过滤器类将默认允许用户过滤由 <cite>serializer_class</cite> 属性指定的序列化器中的任何可读字段，
所以最好指定，避免数据泄漏。</p>
<p>指定默认排序使用ordering:</p>
<pre class="last literal-block">
# 正序
ordering = ('username',) 或 ordering = ['username']
# 倒序
ordering = ('-username',) 或 ordering = ['-username']
</pre>
</dd>
</dl>
</div>
<div class="section" id="searchfilter">
<h4>SearchFilter过滤类</h4>
<p>也可参考: <a class="reference internal" href="#viewset">viewset搜索</a></p>
<p><cite>SearchFilter</cite> 类支持简单的基于单个查询参数的搜索, 并且基于 Django 管理员的搜索功能。</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">UserListView</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListAPIView</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">UserSerializer</span>
    <span class="n">filter_backends</span> <span class="o">=</span> <span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">SearchFilter</span><span class="p">,)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>
</pre></div>
<p>这将允许客户端通过查询来过滤列表中的项，例如:</p>
<pre class="literal-block">
http://example.com/api/users?search=russell
</pre>
<p>还可以使用查找 API 双下划线表示法对 <cite>ForeignKey</cite> 或 <cite>ManyToManyField</cite> 执行相关查找:</p>
<pre class="literal-block">
search_fields = ('username', 'email', 'profile__profession')
</pre>
<p>默认情况下，搜索将使用不区分大小写的部分匹配。
搜索参数可能包含多个搜索项，它们应该是空格和/或逗号分隔的。
如果使用多个搜索项，则只有在所有提供的项匹配的情况下，对象才会返回到列表中。</p>
<p>可以通过在 <cite>search_fields</cite> 之前添加各种字符来限制搜索行为:</p>
<pre class="literal-block">
'^'   开始搜索。
'='   完全匹配。
'&#64;'   全文搜索。(目前只支持 Django 的 MySQL 后端。)
'$'   正则表达式搜索。
</pre>
<p>举个栗子:</p>
<pre class="literal-block">
search_fields = ('=username', '=email')
</pre>
<p>默认情况下，搜索参数被命名为 <cite>'search'</cite> ，但这可能会被 <cite>SEARCH_PARAM</cite> 设置覆盖。</p>
</div>
</div>
<div class="section" id="section-12">
<h3>解析器</h3>
<p><cite>REST framework</cite> 提供了 <cite>Parser</cite> 解析器，
在接收到请求后会自动根据 <cite>Content-Type</cite> 指明的请求数据类型（如JSON、表单等）将请求数据进行 <cite>parse</cite> 解析，解析为只读类字典对象保存到 <cite>Request</cite> 对象中。</p>
<p>无论前端发送的哪种格式的数据，我们只需要使用以下两种方式读取数据</p>
<ul class="simple">
<li><cite>request.data</cite> - 解析后的数据, 类似于Django中标准的 <cite>request.POST</cite> 和 <cite>request.FILES</cite> 属性，
但提供如下特性:<ul>
<li>包含了解析之后的文件和非文件数据</li>
<li>包含了对 <cite>POST、PUT、PATCH</cite> 请求方式解析后的数据</li>
<li>利用了 <cite>REST framework</cite> 的 <cite>parsers</cite> 解析器，不仅支持表单类型数据，也支持JSON数据</li>
</ul>
</li>
<li><cite>request.query_params</cite> - 解析后的查询参数, 基本等价于Django中标准的 <cite>request.GET</cite> 属性</li>
</ul>
<p>配置在配置文件中全局定义</p>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="s1">&#39;DEFAULT_PARSER_CLASSES&#39;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">&#39;rest_framework.parsers.JSONParser&#39;</span><span class="p">,</span>
      <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>在视图中添加parser_classes</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.versioning</span> <span class="kn">import</span> <span class="n">URLPathVersioning</span>
<span class="kn">from</span> <span class="nn">rest_framework.parsers</span> <span class="kn">import</span> <span class="n">JSONParser</span>
<span class="k">class</span> <span class="nc">UserView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;查看用户信息&#39;&#39;&#39;</span>
    <span class="n">parser_classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">JSONParser</span><span class="p">,]</span>
    <span class="n">versioning_class</span> <span class="o">=</span><span class="n">URLPathVersioning</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">res</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;wd&quot;</span><span class="p">,</span><span class="s2">&quot;age&quot;</span><span class="p">:</span><span class="mi">22</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="c1">#获取解析后的请求结果</span>
        <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span><span class="s2">&quot;ok&quot;</span><span class="p">},</span> <span class="n">safe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>预定义解析器</p>
<ul class="simple">
<li>JSONParser ：对应 <cite>'application/json'</cite></li>
<li>FormParser：对应 <cite>'application/x-www-form-urlencoded'</cite></li>
<li>MultiPartParser： 对应 <cite>'multipart/form-data'</cite></li>
<li>FileUploadParser：对应 <cite>'*/*'</cite></li>
</ul>
</div>
<div class="section" id="section-13">
<h3>序列化与反序列化</h3>
<p>基本参考: <a class="reference internal" href="#section-18">表的序列化</a></p>
</div>
</div>
<div class="section" id="restviewset">
<h2>rest预定义的viewset</h2>
<ul>
<li><p class="first"><cite>APIView</cite> - 基于类的视图, 所有rest的视图的基类, 继承自Django的 <cite>View</cite></p>
<p>APIView与View的不同之处在于：</p>
<ul class="simple">
<li>传入到视图方法中的是 <cite>REST framework</cite> 的 <cite>Request</cite> 对象，而不是Django的 <cite>HttpRequeset</cite> 对象；</li>
<li>视图方法可以返回 <cite>REST framework</cite> 的 <cite>Response</cite> 对象，视图会为响应数据设置（render）符合前端要求的格式；</li>
<li>任何 <cite>APIException</cite> 异常都会被捕获到，并且处理成合适的响应信息；</li>
<li>在进行 <cite>dispatch()</cite> 分发前，会对请求进行身份认证、权限检查、流量控制。</li>
</ul>
<p>支持定义的属性：</p>
<ul class="simple">
<li>authentication_classes 列表或元祖，身份认证类</li>
<li>permissoin_classes 列表或元祖，权限检查类</li>
<li>throttle_classes 列表或元祖，流量控制类</li>
</ul>
<p>在APIView中仍以常规的类视图定义方法来实现get() 、post() 或者其他请求方式的方法。</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="c1"># url配置写法</span>
<span class="c1"># url(r&#39;^books/$&#39;, views.BookListView.as_view()),</span>
<span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">books</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">books</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</li>
<li><p class="first"><cite>GenericAPIView</cite> - 提供了常用的功能, 例如分页, 查询, 序列化等</p>
<p>继承自 <cite>APIVIew</cite>, 增加了对于列表视图和详情视图可能用到的通用支持方法</p>
<p>支持定义的属性：</p>
<ul>
<li><p class="first">列表视图与详情视图通用：
- queryset：列表视图的查询集
- serializer_class ：视图使用的序列化器</p>
</li>
<li><p class="first">列表视图使用：
- pagination_class ：分页控制类
- filter_backends ：过滤控制后端</p>
</li>
<li><p class="first">详情页视图使用：
- lookup_field ：查询单一数据库对象时使用的条件字段，默认为'pk'
- lookup_url_kwarg ：查询单一数据时URL中的参数关键字名称，默认与look_field相同</p>
</li>
<li><p class="first">提供的方法, 列表视图与详情视图通用
- <cite>get_queryset(self)</cite> 返回视图使用的查询集，是列表视图与详情视图获取数据的基础，默认返回queryset属性，可以需要进行重写
- <cite>get_serializer_class(self)</cite> 返回序列化器类，默认返回serializer_class，可以需要进行重写，用于不同的接口需要的序列化内容不一致的情况</p>
<blockquote>
<p>比如</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_serializer_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">FullAccountSerializer</span>
  <span class="k">return</span> <span class="n">BasicAccountSerializer</span>
</pre></div>
</blockquote>
<ul>
<li><p class="first"><cite>get_serializer(self, *args, **kwargs)</cite> 返回序列化器对象，被其他视图或扩展类使用，如果我们在视图中想要获取序列化器对象，可以直接调用此方法。</p>
<p>注意，在提供序列化器对象的时候， <cite>REST framework</cite> 会向对象的context属性补充三个数据： <cite>request、format、view</cite> ，
这三个数据对象可以在定义序列化器时使用。</p>
</li>
</ul>
</li>
<li><p class="first">详情视图使用</p>
<ul>
<li><p class="first"><cite>get_object(self)</cite> 返回详情视图所需的模型类数据对象，默认使用 <cite>lookup_field</cite> 参数来过滤 <cite>queryset</cite> 。
在视图中可以调用该方法获取详情信息的模型类对象。</p>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<ol class="arabic simple">
<li>若详情访问的模型类对象不存在，会返回404。</li>
<li>该方法会默认使用 <cite>APIView</cite> 提供的 <cite>check_object_permissions</cite> 方法检查当前对象是否有权限被访问。</li>
</ol>
<div class="last"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

  <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">())</span>

  <span class="c1"># 确认使用的过滤字段.</span>
  <span class="n">lookup_url_kwarg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_url_kwarg</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_field</span>

  <span class="k">assert</span> <span class="n">lookup_url_kwarg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="p">(</span>
      <span class="s1">&#39;Expected view </span><span class="si">%s</span><span class="s1"> to be called with a URL keyword argument &#39;</span>
      <span class="s1">&#39;named &quot;</span><span class="si">%s</span><span class="s1">&quot;. Fix your URL conf, or set the `.lookup_field` &#39;</span>
      <span class="s1">&#39;attribute on the view correctly.&#39;</span> <span class="o">%</span>
      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">lookup_url_kwarg</span><span class="p">)</span>
  <span class="p">)</span>

  <span class="n">filter_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup_field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="n">lookup_url_kwarg</span><span class="p">]}</span>
  <span class="c1"># 模型类对象不存在，会返回404</span>
  <span class="n">obj</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="o">**</span><span class="n">filter_kwargs</span><span class="p">)</span>

  <span class="c1"># 权限校验</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">check_object_permissions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">obj</span>
</pre></div>
</div></div>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>返回序列化器对象，被其他视图或扩展类使用，如果我们在视图中想要获取序列化器对象，可以直接调用此方法。</p>
<p>注意，在提供序列化器对象的时候，REST framework会向对象的context属性补充三个数据：request、format、view，这三个数据对象可以在定义序列化器时使用。</p>
<ul class="simple">
<li><cite>ListAPIView</cite> - 列表视图</li>
<li><cite>CreateAPIView</cite> - 创建视图</li>
<li><cite>RetrieveAPIView</cite> - 检索视图</li>
<li><cite>UpdateAPIView</cite> - 更新视图</li>
<li><cite>DestroyAPIView</cite> - 删除视图</li>
<li><cite>ListCreateAPIView</cite> - 列表和创建视图</li>
<li><cite>RetrieveUpdateAPIView</cite> - 检索和更新视图</li>
<li><cite>RetrieveDestroyAPIView</cite> - 检索和删除视图</li>
<li><cite>RetrieveUpdateDestroyAPIView</cite> - 检索, 更新和删除视图</li>
</ul>
<p>还有结合上面部分一起的</p>
<ul class="simple">
<li><cite>ViewSet</cite> - 提供了所有的CRUD操作, 但是不提供路由</li>
<li><cite>ReadOnlyViewSet</cite> - 只读的ViewSet</li>
<li><cite>GenericViewSet</cite> - 提供了常用的功能, 例如分页, 查询, 序列化等</li>
<li><cite>ModelViewSet</cite> - 提供了所有的CRUD操作</li>
<li><cite>ReadOnlyModelViewSet</cite> - 只读的ModelViewSet</li>
</ul>
<p>一般来说, 请求方法与 <cite>ModelViewSet</cite> 对应关系如下:</p>
<ul class="simple">
<li><cite>GET</cite> - <cite>list</cite> 和 <cite>retrieve</cite></li>
<li><cite>POST</cite> - <cite>create</cite></li>
<li><cite>PUT</cite> - <cite>update</cite></li>
<li><cite>PATCH</cite> - <cite>partial_update</cite></li>
<li><cite>DELETE</cite> - <cite>destroy</cite></li>
</ul>
<p>其中</p>
<ul>
<li><p class="first"><cite>list</cite> 和 <cite>retrieve</cite> 是 <cite>ModelViewSet</cite> 中的两个方法, 分别对应 <cite>GET</cite> 请求的列表和单个对象的获取.</p>
<p>两者区别就是一个是获取列表, 一个是获取单个对象.</p>
<p>url使用上的区别就是(默认情况下)</p>
<ul class="simple">
<li><cite>list</cite> 对应的 url 是 <cite>/api/v1/users/</cite></li>
<li><cite>retrieve</cite> 直接路径包含主键id, 对应的 url 是 <cite>/api/v1/users/&lt;id&gt;/</cite></li>
</ul>
</li>
<li><p class="first"><cite>create</cite> 是 <cite>ModelViewSet</cite> 中的一个方法, 对应 <cite>POST</cite> 请求的创建.</p>
</li>
<li><p class="first"><cite>update</cite> 是 <cite>ModelViewSet</cite> 中的一个方法, 对应 <cite>PUT</cite> 请求的更新. 注意此处的更新必须更新所有必填字段</p>
</li>
<li><p class="first"><cite>partial_update</cite> 是 <cite>ModelViewSet</cite> 中的一个方法, 对应 <cite>PATCH</cite> 请求的部分更新. 此处更新可以只更新部分字段</p>
</li>
</ul>
<p>注意对应的URL大致为:</p>
<pre class="literal-block">
def register() -&gt; BaseRouter:
  router = routers.DefaultRouter()

  # list  :  ^musicScrape/$
  # get   :  ^musicScrape/{pk}/$
  # post  :  ^musicScrape/$
  # put   :  ^musicScrape/{pk}/$
  # delete:  ^musicScrape/{pk}/$
  router.register(r'musicScrape', MSMusicReadViewSet)

  return router
</pre>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p><cite>put</cite>, <cite>delete</cite> 请求要求请求的URL路径中必须有主键id, 否则会出现类似 <tt class="docutils literal">PUT is not Allowed</tt> 的错误</p>
<p>另外, 如果URL不是使用的 <cite>pk</cite> 主键查询, 需要设置 <cite>lookup_url_kwarg</cite> 以及 <cite>lookup_field</cite> 覆盖 <cite>lookup_field=pk</cite>:</p>
<pre class="last literal-block">
# Perform the lookup filtering.
lookup_url_kwarg = self.lookup_url_kwarg or self.lookup_field
...
filter_kwargs = {self.lookup_field: self.kwargs[lookup_url_kwarg]}
obj = get_object_or_404(queryset, **filter_kwargs)
</pre>
</div>
<div class="section" id="section-14">
<h3>五个扩展类</h3>
<dl class="docutils">
<dt>ListModelMixin</dt>
<dd>提供了列表视图的功能, 继承自 <cite>GenericAPIView</cite> 和 <cite>ListModelMixin</cite> 类</dd>
<dt>CreateModelMixin</dt>
<dd>提供了创建视图的功能, 继承自 <cite>GenericAPIView</cite> 和 <cite>CreateModelMixin</cite> 类</dd>
<dt>RetrieveModelMixin</dt>
<dd>提供了检索视图的功能, 继承自 <cite>GenericAPIView</cite> 和 <cite>RetrieveModelMixin</cite> 类</dd>
<dt>UpdateModelMixin</dt>
<dd>提供了更新视图的功能, 继承自 <cite>GenericAPIView</cite> 和 <cite>UpdateModelMixin</cite> 类</dd>
<dt>DestroyModelMixin</dt>
<dd>提供了删除视图的功能, 继承自 <cite>GenericAPIView</cite> 和 <cite>DestroyModelMixin</cite> 类</dd>
</dl>
</div>
<div class="section" id="modelviewset">
<h3>ModelViewSet使用</h3>
<p>如果只需要纯数据</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>

<span class="k">class</span> <span class="nc">BaseViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>

  <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span> <span class="p">)</span>

  <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="n">ret</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">data</span>

  <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="n">ret</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">data</span>

  <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="n">ret</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">data</span>

  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="n">ret</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">data</span>

  <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="n">ret</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">destroy</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">data</span>

  <span class="k">def</span> <span class="nf">partial_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="n">ret</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">partial_update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<div class="section" id="viewset">
<h3>viewset搜索</h3>
<ul class="simple">
<li><cite>search_fields</cite> - 搜索字段, 用于搜索, 默认为空, 表示搜索所有字段</li>
<li><cite>filter_backends</cite> - 过滤器, 用于过滤数据</li>
<li><cite>ordering_fields</cite> - 排序字段, 用于排序数据</li>
<li><cite>filterset_fields</cite> - 过滤器字段, 用于过滤数据</li>
</ul>
<p>默认情况下的 <cite>filter_backends</cite></p>
<pre class="literal-block">
class CategoryViewSet(BaseViewSet):
    queryset = Category.objects.all()
    serializer_class = CategorySerializer
    permission_classes = (IsAuthenticatedOrReadOnly, )
    filter_backends = (filters.DjangoFilterBackend, filters.SearchFilter)
</pre>
<p>调用流程</p>
<ol class="arabic simple">
<li><cite>view</cite> 调用 <cite>get_queryset</cite> 拿到 <cite>queryset</cite></li>
<li><cite>filter_backends</cite> 用取到所有的 <cite>backend</cite> 进行 <cite>filter</cite></li>
</ol>
<p><cite>queryset</cite> 只有实际查询的时候才会触发数据库操作, 所以可以简单的组合多个 <cite>backend</cite> 进行查询.
源码部分</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ListModelMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List a queryset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">())</span>

        <span class="n">page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginated_response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">serializer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_serializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GenericAPIView</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">APIView</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a queryset, filter it with whichever filter backend is in use.</span>

<span class="sd">        You are unlikely to want to override this method, although you may need</span>
<span class="sd">        to call it either from a list view, or from a custom `get_object`</span>
<span class="sd">        method if you want to apply the configured filtering backend to the</span>
<span class="sd">        default queryset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">backend</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_backends</span><span class="p">):</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="n">backend</span><span class="p">()</span><span class="o">.</span><span class="n">filter_queryset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">queryset</span>
</pre></div>
<p>在 <cite>view</cite> 中, 当使用 <cite>filter_class</cite> 时就不要写 <cite>filter_fields</cite> 了，
因为对应的 <cite>Class</cite> 中有一个 <cite>Meta Class</cite> 的 <cite>fields</cite> 属性代替了 <cite>filter_fields</cite> 。</p>
</div>
<div class="section" id="section-15">
<h3>分页</h3>
<p>配置文件中设置全局的分页方式，如</p>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># &#39;DEFAULT_PAGINATION_CLASS&#39;: &#39;rest_framework.pagination.LimitOffsetPagination&#39;,</span>
    <span class="s1">&#39;DEFAULT_PAGINATION_CLASS&#39;</span><span class="p">:</span>  <span class="s1">&#39;rest_framework.pagination.PageNumberPagination&#39;</span><span class="p">,</span>
    <span class="s1">&#39;PAGE_SIZE&#39;</span><span class="p">:</span> <span class="mi">5</span>  <span class="c1"># 每页数目</span>
<span class="p">}</span>
</pre></div>
<p>也可在视图中通过pagination_class属性来指明</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">PageNumberPagination</span>

<span class="k">class</span> <span class="nc">BookDetailViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">PageNumberPagination</span>
</pre></div>
<p>如果在视图内关闭分页功能，只需在视图内设置:</p>
<pre class="literal-block">
pagination_class = None
</pre>
<div class="section" id="section-16">
<h4>自定义分页类</h4>
<ul class="simple">
<li>继承 <cite>PageNumberPagination</cite> ，自定义 <cite>get_paginated_response(self, data)</cite> 函数</li>
<li>返回 <cite>Response</cite> 对象</li>
</ul>
<p>比如</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework.pagination</span> <span class="kn">import</span> <span class="n">PageNumberPagination</span>

<span class="k">class</span> <span class="nc">StandardPageNumberPagination</span><span class="p">(</span><span class="n">PageNumberPagination</span><span class="p">):</span>
    <span class="n">page_size_query_param</span> <span class="o">=</span> <span class="s1">&#39;page_size&#39;</span>
    <span class="n">max_page_size</span> <span class="o">=</span> <span class="mi">10</span>

<span class="k">class</span> <span class="nc">BookDetailViewSet</span><span class="p">(</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span>
    <span class="n">pagination_class</span> <span class="o">=</span> <span class="n">StandardPageNumberPagination</span>
</pre></div>
<p>使用 <cite>books/?page=1&amp;page_size=5</cite> 请求每页会返回5条数据</p>
</div>
<div class="section" id="section-17">
<h4>预定义分页组件</h4>
<p>DjangoRestFramework提供了三种分页组件：</p>
<dl class="docutils">
<dt>PageNumberPagination</dt>
<dd><p class="first">普通分页，查看第n页，每个页面显示n条数据。可以在子类中定义的属性：</p>
<ul class="last simple">
<li>page_size 每页数目</li>
<li>page_query_param 前端发送的页数关键字名，默认为&quot;page&quot;</li>
<li>page_size_query_param 前端发送的每页数目关键字名，默认为None</li>
<li>max_page_size 前端最多能设置的每页数量</li>
</ul>
</dd>
<dt>LimitOffsetPagination</dt>
<dd><p class="first">基于位置的分页，在第n个位置，向后查看n条数据，
和数据库的sql语句中的 <cite>limit</cite> <cite>offset</cite> 类似，
参数 <cite>offet</cite> 代表位置， <cite>limit</cite> 代表取多少条数据。可以在子类中定义的属性：</p>
<ul class="last simple">
<li>default_limit , 默认限制，默认值与 <cite>PAGE_SIZE</cite> 设置一样</li>
<li>limit_query_param , limit参数名，默认 <cite>'limit'</cite></li>
<li>offset_query_param , offset参数名，默认 <cite>'offset'</cite></li>
<li>max_limit , 最大limit限制，默认 <cite>None</cite></li>
</ul>
</dd>
<dt>CursorPagination</dt>
<dd><p class="first">游标分页，意思就是每次返回当前页、上一页、下一页，
并且每次的上一页和下一页的url是不规则的。</p>
<ul class="last simple">
<li>cursor_query_param 参数名，默认为'cursor'</li>
<li>page_size 每页数目</li>
<li>page_size_query_param 参数名，默认为None</li>
<li>max_page_size 前端最多能设置的每页数量</li>
<li>ordering 排序规则，默认为'-created'</li>
</ul>
</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="section-18">
<h2>表的序列化</h2>
<p>序列化器允许将复杂数据 (如查询集和模型实例) 转换为可以轻松渲染成 JSON , XML 或其他内容类型的原生 Python 数据类型.
支持反序列化.</p>
<ul>
<li><p class="first"><cite>serializers.ModelSerializer</cite> - 序列化器, 用于将模型转换为JSON格式</p>
<p>传入模型 <cite>queryset</cite>, <cite>.data</cite> 输出序列化后的数据</p>
</li>
<li><p class="first"><cite>serializers.Serializer</cite> - 序列化器, 用于将数据转换为JSON格式</p>
<p><cite>Serializer</cite> 不是只能为数据库模型类定义，也可以为非数据库模型类的数据定义序列化器。</p>
<p>创建一个类（非数据库模型类）</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># 三个字段</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">created</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

<span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;leila@example.com&#39;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="s1">&#39;foo bar&#39;</span><span class="p">)</span>
</pre></div>
<p>序列化的声明如下：</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="k">class</span> <span class="nc">CommentSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
  <span class="c1"># 对应上面定义的三个字段</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">()</span>
</pre></div>
<p>这样便可以通过序列化类，实现 Python 原生的数据类型（这里是comment对象）与Json格式数据的相互转换。</p>
<div class="highlight"><pre><span></span><span class="c1"># 序列化</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">CommentSerializer</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
<span class="c1"># 序列化后的json数据</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># 反序列化（json格式数据转回Comment类对象类型）</span>
<span class="n">serializer</span> <span class="o">=</span> <span class="n">CommentSerializer</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># 验证</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span>
<span class="n">serializer</span><span class="o">.</span><span class="n">validated_data</span>
</pre></div>
</li>
</ul>
<div class="section" id="section-19">
<h3>字段</h3>
<ul class="simple">
<li><cite>serializers.SerializerMethodField</cite> - 序列化器方法字段, 用于自定义序列化字段</li>
<li><cite>serializers.PrimaryKeyRelatedField</cite> - 主键关联字段, 用于关联其他模型</li>
<li><cite>serializers.StringRelatedField</cite> - 字符串关联字段, 用于关联其他模型</li>
<li><cite>serializers.HyperlinkedRelatedField</cite> - 超链接关联字段, 用于关联其他模型</li>
<li><cite>serializers.SlugRelatedField</cite> - Slug关联字段, 用于关联其他模型</li>
<li><cite>serializers.ListField</cite> - 列表字段, 用于序列化列表数据</li>
<li><cite>serializers.DictField</cite> - 字典字段, 用于序列化字典数据</li>
<li><cite>serializers.JSONField</cite> - JSON字段, 用于序列化JSON数据</li>
<li><cite>serializers.FileField</cite> - 文件字段, 用于序列化文件数据</li>
<li><cite>serializers.ImageField</cite> - 图片字段, 用于序列化图片数据</li>
<li><cite>serializers.EmailField</cite> - 邮箱字段, 用于序列化邮箱数据</li>
<li><cite>serializers.URLField</cite> - URL字段, 用于序列化URL数据</li>
<li><cite>serializers.CharField</cite> - 字符串字段, 用于序列化字符串数据</li>
<li><cite>serializers.IntegerField</cite> - 整数字段, 用于序列化整数字段</li>
<li><cite>serializers.FloatField</cite> - 浮点数字段, 用于序列化浮点数字段</li>
<li><cite>serializers.BooleanField</cite> - 布尔字段, 用于序列化布尔数据</li>
<li><cite>serializers.DateField</cite> - 日期字段, 用于序列化日期数据</li>
<li><cite>serializers.DateTimeField</cite> - 日期时间字段, 用于序列化日期时间数据</li>
<li><cite>serializers.TimeField</cite> - 时间字段, 用于序列化时间数据</li>
<li><cite>serializers.DecimalField</cite> - 十进制字段, 用于序列化十进制数据</li>
<li><cite>serializers.ChoiceField</cite> - 选择字段, 用于序列化选择数据</li>
<li><cite>serializers.ChoiceField</cite> - 选择字段, 用于序列化选择数据</li>
<li><cite>serializers.MultipleChoiceField</cite> - 多选字段, 用于序列化多选数据</li>
<li><cite>serializers.RegexField</cite> - 正则表达式字段, 用于序列化正则表达式数据</li>
<li><cite>serializers.UUIDField</cite> - UUID字段, 用于序列化UUID数据</li>
<li><cite>serializers.HiddenField</cite> - 隐藏字段, 用于序列化隐藏数据</li>
<li><cite>serializers.ReadOnlyField</cite> - 只读字段, 用于序列化只读数据</li>
<li><cite>serializers.WriteOnlyField</cite> - 只写字段, 用于序列化只写数据</li>
<li><cite>serializers.SerializerMethodField</cite> - 序列化器方法字段, 用于自定义序列化字段</li>
<li><cite>serializers.ValidationError</cite> - 验证错误, 用于验证数据</li>
</ul>
<div class="section" id="section-20">
<h4>日期字段的格式化</h4>
<p>使用 <cite>serializers.DateField</cite> 日期字段序列化日期数据</p>
<p>比如</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">input_formats</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">])</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</pre></div>
<!-- # 序列化 -->
<!-- serializer = BookInfoSerializer(bookinfo) -->
<!-- serializer.data -->
<!-- # 反序列化 -->
<!-- serializer = BookInfoSerializer(data=data) -->
<!-- serializer.is_valid() -->
<!-- serializer.validated_data -->
</div>
</div>
<div class="section" id="section-21">
<h3>关联对象嵌套序列化</h3>
<p>大致有三种方式</p>
<ul class="simple">
<li>使用外关联对象嵌套序列化</li>
<li>序列化为对应对象的 str 形式</li>
<li>直接给自定义的序列化器</li>
</ul>
<dl class="docutils">
<dt>PrimaryKeyRelatedField</dt>
<dd><p class="first">此字段将被序列化为关联对象的主键。属性使用 <cite>related_name</cite> 的值，如果没有则使用关联类小写 <cite>_set(heroinfo_set)</cite></p>
<p>指定 <cite>read_only=True</cite> 时，该字段将不能用作反序列化使用:</p>
<pre class="last literal-block">
user = serializers.PrimaryKeyRelatedField(read_only=True)
</pre>
</dd>
<dt>StringRelatedField</dt>
<dd>此字段将被序列化为关联对象的字符串表示方式（即关联模型类 <cite>__str__</cite> 方法的返回值）</dd>
<dt>使用关联对象的序列化器</dt>
<dd><div class="first last"><div class="highlight"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">UserInfoSerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># 根据指定的UserInfoSerialzier序列化中指定的字段返回</span>
</pre></div>
</div></dd>
</dl>
</div>
<div class="section" id="section-22">
<h3>反序列化</h3>
<ul class="simple">
<li>使用序列化器进行反序列化时，需要对数据进行验证后，才能获取验证成功的数据或保存成模型类对象；</li>
<li>在获取反序列化的数据前，必须调用 <cite>is_valid()</cite> 方法进行验证，验证成功返回True，否则返回False；</li>
<li>验证失败，可以通过序列化器对象的errors属性获取错误信息，返回字典，包含了字段和字段的错误。
如果是非字段错误，可以通过修改 <cite>REST framework</cite> 配置中的 <cite>NON_FIELD_ERRORS_KEY</cite> 来控制错误字典中的键名；</li>
<li>验证成功，可以通过序列化器对象的 <cite>validated_data</cite> 属性获取数据。</li>
</ul>
</div>
<div class="section" id="section-23">
<h3>反向序列化</h3>
<p>多对多字段/一对多字段表的反向序列化</p>
<p>比如定义如下表</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;作者名&quot;</span><span class="p">)</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s1">&#39;BookInfo&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;authors_by_book&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<span class="k">class</span> <span class="nc">BookInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;书名&quot;</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;出版日期&quot;</span><span class="p">)</span>
    <span class="n">read</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;阅读量&quot;</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;评论量&quot;</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s1">&#39;booktest&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;图片&quot;</span><span class="p">)</span>
</pre></div>
<p>此定义表达的含义是, <cite>一个作者写了多本书</cite>, <cite>一本书可以有多个作者</cite>。</p>
<p>正常情况下定义默认的序列化器如下</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AuthorSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">books</span> <span class="o">=</span> <span class="n">BookInfoSerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Author</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>

<span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</pre></div>
<p>现在问题来了, 我想在 <cite>BookInfoSerializer</cite> 中反向查询 <cite>AuthorSerializer</cite> , 应该如何操作</p>
<p>使用 <cite>related_name</cite> 进行反向查询即可</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">authors_by_book</span> <span class="o">=</span> <span class="n">AuthorSerializer</span><span class="p">(</span><span class="n">many</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
</pre></div>
</div>
<div class="section" id="section-24">
<h3>自定义验证规则</h3>
<p>验证单一字段</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
    <span class="c1"># 方法名定义为validated_字段名</span>
    <span class="k">def</span> <span class="nf">validated_btitle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;书名python错误&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>
<p>验证多个字段</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
  <span class="c1"># 方法名定义为validate</span>
    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="n">bread</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bread&#39;</span><span class="p">]</span>
        <span class="n">bcomment</span> <span class="o">=</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;bcomment&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bread</span> <span class="o">&lt;</span> <span class="n">bcomment</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;阅读量小于评论量&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">attrs</span>
</pre></div>
</div>
<div class="section" id="section-25">
<h3>保存数据</h3>
<p>如果在验证成功后，想要基于 <cite>validated_data</cite> 类属性完成数据对象的创建，可以通过实现 <cite>create()</cite> 和 <cite>update()</cite> 两个方法来实现。</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">Serializer</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;图书数据序列化器&quot;&quot;&quot;</span>
  <span class="o">...</span>

  <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;新建&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">BookInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">validated_data</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;更新，instance为要更新的对象实例&quot;&quot;&quot;</span>
      <span class="n">instance</span><span class="o">.</span><span class="n">btitle</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;btitle&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">btitle</span><span class="p">)</span>
      <span class="n">instance</span><span class="o">.</span><span class="n">bpub_date</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bpub_date&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">bpub_date</span><span class="p">)</span>
      <span class="n">instance</span><span class="o">.</span><span class="n">bread</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bread&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">bread</span><span class="p">)</span>
      <span class="n">instance</span><span class="o">.</span><span class="n">bcomment</span> <span class="o">=</span> <span class="n">validated_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bcomment&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">bcomment</span><span class="p">)</span>
      <span class="c1"># 存入数据库</span>
      <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
      <span class="k">return</span> <span class="n">instance</span>
</pre></div>
<div class="admonition note">
<p class="first admonition-title">注解</p>
<p class="last">如果创建序列化器对象的时候，
没有传递instance实例，则调用 <cite>save()</cite> 方法的时候， <cite>create()</cite> 被调用，
相反，如果传递了instance实例，则调用 <cite>save()</cite> 方法的时候， <cite>update()</cite> 被调用。</p>
</div>
</div>
<div class="section" id="modelserializer">
<h3>ModelSerializer自定义模型序列化器</h3>
<p><cite>ModelSerializer</cite> 与常规的 <cite>Serializer</cite> 相同，但提供了：</p>
<ul class="simple">
<li>基于模型类自动生成一系列字段</li>
<li>基于模型类自动为 <cite>Serializer</cite> 生成 <cite>validators</cite> ，比如 <cite>unique_together</cite></li>
<li>包含默认的 <cite>create()</cite> 和 <cite>update()</cite> 的实现， <cite>update</cite> 方法不支持多个创建</li>
</ul>
<p>定义, 要使用要继承 <cite>serializers.ModelSerializer`</cite></p>
<p>比如我们创建一个 <cite>BookInfoSerializer</cite></p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BookInfoSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
<span class="w">  </span><span class="sd">&quot;&quot;&quot;图书数据序列化器&quot;&quot;&quot;</span>
  <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
      <span class="n">model</span> <span class="o">=</span> <span class="n">BookInfo</span>
      <span class="c1"># 返回所有字段</span>
      <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>
      <span class="c1"># 返回特定字段</span>
      <span class="c1"># fields = [&#39;id&#39;, &#39;name&#39;]</span>
      <span class="c1"># 除去特定字段</span>
      <span class="c1"># exclude = [&#39;id&#39;]</span>
</pre></div>
<ul class="simple">
<li>model 指明参照哪个模型类</li>
<li>fields 指明为模型类的哪些字段生成</li>
<li>exclude 指明不生成那些字段，与 <cite>fields</cite> 只能二选一进行使用</li>
</ul>
<p>可以在django环境中执行 <cite>python manage.py shell</cite> 命令来查看自动生成的 <cite>BookInfoSerializer</cite> 的具体实现</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt;<span class="w"> </span>from<span class="w"> </span>booktest.serializers<span class="w"> </span>import<span class="w"> </span>BookInfoSerializer
&gt;&gt;&gt;<span class="w"> </span><span class="nv">serializer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>BookInfoSerializer<span class="o">()</span>
&gt;&gt;&gt;<span class="w"> </span>serializer
BookInfoSerializer<span class="o">()</span>:
<span class="w">    </span><span class="nv">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IntegerField<span class="o">(</span><span class="nv">label</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span>,<span class="w"> </span><span class="nv">read_only</span><span class="o">=</span>True<span class="o">)</span>
<span class="w">    </span><span class="nv">btitle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>CharField<span class="o">(</span><span class="nv">label</span><span class="o">=</span><span class="s1">&#39;名称&#39;</span>,<span class="w"> </span><span class="nv">max_length</span><span class="o">=</span><span class="m">20</span><span class="o">)</span>
<span class="w">    </span><span class="nv">bpub_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>DateField<span class="o">(</span><span class="nv">allow_null</span><span class="o">=</span>True,<span class="w"> </span><span class="nv">label</span><span class="o">=</span><span class="s1">&#39;发布日期&#39;</span>,<span class="w"> </span><span class="nv">required</span><span class="o">=</span>False<span class="o">)</span>
<span class="w">    </span><span class="nv">bread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IntegerField<span class="o">(</span><span class="nv">label</span><span class="o">=</span><span class="s1">&#39;阅读量&#39;</span>,<span class="w"> </span><span class="nv">max_value</span><span class="o">=</span><span class="m">2147483647</span>,<span class="w"> </span><span class="nv">min_value</span><span class="o">=</span>-2147483648,<span class="w"> </span><span class="nv">required</span><span class="o">=</span>False<span class="o">)</span>
<span class="w">    </span><span class="nv">bcomment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>IntegerField<span class="o">(</span><span class="nv">label</span><span class="o">=</span><span class="s1">&#39;评论量&#39;</span>,<span class="w"> </span><span class="nv">max_value</span><span class="o">=</span><span class="m">2147483647</span>,<span class="w"> </span><span class="nv">min_value</span><span class="o">=</span>-2147483648,<span class="w"> </span><span class="nv">required</span><span class="o">=</span>False<span class="o">)</span>
<span class="w">    </span><span class="nv">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ImageField<span class="o">(</span><span class="nv">allow_null</span><span class="o">=</span>True,<span class="w"> </span><span class="nv">label</span><span class="o">=</span><span class="s1">&#39;图片&#39;</span>,<span class="w"> </span><span class="nv">max_length</span><span class="o">=</span><span class="m">100</span>,<span class="w"> </span><span class="nv">required</span><span class="o">=</span>False<span class="o">)</span>
</pre></div>
<dl class="docutils">
<dt>添加额外参数</dt>
<dd>可以使用 <cite>extra_kwargs</cite> 参数为 <cite>ModelSerializer</cite> 添加或修改原有的选项参数</dd>
</dl>
<div class="section" id="section-26">
<h4>用例</h4>
<p>有一个如下的模型</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
  <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;分类名&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>
<p>定义序列化类</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span><span class="p">,</span> <span class="n">serializers</span><span class="p">,</span> <span class="n">viewsets</span><span class="p">,</span> <span class="n">mixins</span>

<span class="k">class</span> <span class="nc">CategorySerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
  <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
      <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
      <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>

  <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">validated_data</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 创建数据 &quot;&quot;&quot;</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; Dict of native values -&gt; Object instance. &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">validated_data</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">run_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">empty</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      We override the default `run_validation`, because the validation</span>
<span class="sd">      performed by validators and the `.validate()` method should</span>
<span class="sd">      be coerced into an error dictionary with a &#39;non_fields_error&#39; key.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="o">...</span>

  <span class="k">def</span> <span class="nf">run_validators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Add read_only fields with defaults to value before running validators.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
          <span class="n">to_validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only_defaults</span><span class="p">()</span>
          <span class="n">to_validate</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">to_validate</span> <span class="o">=</span> <span class="n">value</span>
      <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run_validators</span><span class="p">(</span><span class="n">to_validate</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">to_representation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Category</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 序列化数据 &quot;&quot;&quot;</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; Object instance -&gt; Dict of primitive datatypes. &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">to_representation</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">to_internal_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Category</span><span class="p">:</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 反序列化需要的数据 &quot;&quot;&quot;</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; Dict of native values &lt;- Dict of primitive datatypes. &quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="n">SelectOption</span><span class="o">.</span><span class="n">to_ins_dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
<span class="w">      </span><span class="sd">&quot;&quot;&quot; 查询是不是已经数据库存在了 &quot;&quot;&quot;</span>
      <span class="k">assert</span> <span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
      <span class="n">obj</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">obj</span>

      <span class="k">return</span> <span class="n">attrs</span>

      <span class="c1"># 或者 可以 预处理 validated_data</span>
      <span class="c1"># if &#39;some_field&#39; in data:</span>
      <span class="c1">#     data[&#39;processed_field&#39;] = data[&#39;some_field&#39;].upper()  # 转换数据</span>
      <span class="c1"># return data  # 返回处理后的数据</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="rest">
<h2>rest预定义的路由配置</h2>
<ul class="simple">
<li><cite>routers.DefaultRouter</cite> - 默认路由</li>
<li><cite>routers.SimpleRouter</cite> - 简单路由</li>
<li><cite>routers.APIRootRouter</cite> - API根路由</li>
</ul>
<p>例子</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
<span class="kn">from</span> <span class="nn">rest_framework.routers</span> <span class="kn">import</span> <span class="n">BaseRouter</span>

<span class="k">class</span> <span class="nc">CategoryViewSet</span><span class="p">(</span><span class="n">BaseViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">CategorySerializer</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsAuthenticatedOrReadOnly</span><span class="p">,</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">BaseRouter</span><span class="p">:</span>
  <span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>

  <span class="c1"># 列表查询 ^category/$</span>
  <span class="c1"># 单个查询 ^category/{pk}/$</span>
  <span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">CategoryViewSet</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">router</span>
</pre></div>
<p>然后在 <cite>urls.py</cite> 中添加路由配置</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="n">json_router</span> <span class="o">=</span> <span class="n">register</span><span class="p">()</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;rest/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">json_router</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="section" id="section-27">
<h2>异步</h2>
<p>参考: <a class="reference external" href="/yq-docs-rear-end-python-python-three--party-library-adrf.html">adrf</a></p>
</div>

								</article>
						</div>
					</div>
				</div>
			</section>
	</div>
</div>

				</div>
			</div>



		<!-- Sider Bar -->
		<div id="right-side-bar">
	<nav>
		<div id="top-toc-tree-container" class="fixed-container">
			<div class="toc-contents-title">
				<h4 id="toc-contents-title-text">Contents</h4>
				<!-- <span class="tool-tip-text">点击隐藏</span> -->
			</div>
			<div id="toc-tree-container">
 <ul class="toc-tree visible">
  <li class="toc-h0">
   <a class="" href="#section-1">
    配置相关
   </a>
   <ul class="toc-tree visible">
    <li class="toc-h1">
     <a class="" href="#section-2">
      认证方式配置
     </a>
     <ul class="toc-tree visible">
      <li class="toc-h2">
       <a class="" href="#section-3">
        自定义认证类
       </a>
      </li>
     </ul>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-4">
      权限配置
     </a>
     <ul class="toc-tree visible">
      <li class="toc-h2">
       <a class="" href="#section-5">
        自定义权限控制类
       </a>
      </li>
     </ul>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-6">
      限流
     </a>
     <ul class="toc-tree visible">
      <li class="toc-h2">
       <a class="" href="#section-7">
        自定义限流类
       </a>
      </li>
     </ul>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-8">
      多版本接口
     </a>
     <ul class="toc-tree visible">
      <li class="toc-h2">
       <a class="" href="#section-9">
        自定义版本控制类
       </a>
      </li>
     </ul>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-10">
      过滤/搜索
     </a>
     <ul class="toc-tree visible">
      <li class="toc-h2">
       <a class="" href="#section-11">
        自定义过滤类
       </a>
      </li>
      <li class="toc-h2">
       <a class="" href="#orderingfilter">
        排序OrderingFilter
       </a>
      </li>
      <li class="toc-h2">
       <a class="" href="#searchfilter">
        SearchFilter过滤类
       </a>
      </li>
     </ul>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-12">
      解析器
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-13">
      序列化与反序列化
     </a>
    </li>
   </ul>
  </li>
  <li class="toc-h0">
   <a class="" href="#restviewset">
    rest预定义的viewset
   </a>
   <ul class="toc-tree visible">
    <li class="toc-h1">
     <a class="" href="#section-14">
      五个扩展类
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#modelviewset">
      ModelViewSet使用
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#viewset">
      viewset搜索
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-15">
      分页
     </a>
     <ul class="toc-tree visible">
      <li class="toc-h2">
       <a class="" href="#section-16">
        自定义分页类
       </a>
      </li>
      <li class="toc-h2">
       <a class="" href="#section-17">
        预定义分页组件
       </a>
      </li>
     </ul>
    </li>
   </ul>
  </li>
  <li class="toc-h0">
   <a class="" href="#section-18">
    表的序列化
   </a>
   <ul class="toc-tree visible">
    <li class="toc-h1">
     <a class="" href="#section-19">
      字段
     </a>
     <ul class="toc-tree visible">
      <li class="toc-h2">
       <a class="" href="#section-20">
        日期字段的格式化
       </a>
      </li>
     </ul>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-21">
      关联对象嵌套序列化
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-22">
      反序列化
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-23">
      反向序列化
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-24">
      自定义验证规则
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#section-25">
      保存数据
     </a>
    </li>
    <li class="toc-h1">
     <a class="" href="#modelserializer">
      ModelSerializer自定义模型序列化器
     </a>
     <ul class="toc-tree visible">
      <li class="toc-h2">
       <a class="" href="#section-26">
        用例
       </a>
      </li>
     </ul>
    </li>
   </ul>
  </li>
  <li class="toc-h0">
   <a class="" href="#rest">
    rest预定义的路由配置
   </a>
  </li>
  <li class="toc-h0">
   <a class="" href="#section-27">
    异步
   </a>
  </li>
 </ul>
</div>

		</div>
	</nav>
	<div id="sidebar-tools" class="fixed-container no-active cant-select">
		<!-- 按钮 使用 content 绘制图标 -->
	</div>
	<div id="sidebar-tool-back-top" class="fixed-container cant-select">
		<!-- 按钮 使用 content 绘制图标 -->
	</div>
		</div>

		<!-- Footer Wrapper -->
			<div id="footer-wrapper">
				<!-- Footer -->
					<section id="footer" class="container">
						<div class="row">
							<div class="8u">
								<section>
									<header>
										<h2>Latest articles</h2>
									</header>
									<ul class="dates">
										<li>
											<span class="date">May <strong>18</strong></span>
											<h3><a href="yq-docs-rear-end-python-python-three--party-library-adrf.html">adrf</a></h3>
											<p><p class="first last">adrf</p>
</p>
										</li>
										<li>
											<span class="date">May <strong>12</strong></span>
											<h3><a href="yq-docs-operating-system-linux-Linux-instruction-magick.html">magick</a></h3>
											<p><p class="first last">magick</p>
</p>
										</li>
										<li>
											<span class="date">May <strong>07</strong></span>
											<h3><a href="yq-docs-front-end-question-lcp.html">记录一次LCP问题</a></h3>
											<p><p class="first last">记录一次LCP问题</p>
</p>
										</li>
										<li>
											<span class="date">May <strong>04</strong></span>
											<h3><a href="yq-docs-front-end-node-Three--party-library-react-virtualized.html">react-virtualized</a></h3>
											<p><p class="first last">react-virtualized</p>
</p>
										</li>
									</ul>
								</section>
							</div>
						</div>
						<div class="row">
							<div class="4u">
								<section>
									<header>
										<h2>Blogroll</h2>
									</header>
									<ul class="divided">
											<li><a href="https://yq-yqr.readthedocs.io/zh/blog-theme/blog.html">旧版(迁移中)</a></li>
											<li><a href="https://getpelican.com/">Pelican</a></li>
											<li><a href="https://www.python.org/">Python.org</a></li>
											<li><a href="https://palletsprojects.com/p/jinja/">Jinja2</a></li>
									</ul>
								</section>
							</div>
							<div class="4u">
								<section>
									<header>
										<h2>Categories</h2>
									</header>
									<ul class="divided">
											<li><a href="/category/ai.html">AI</a></li>
											<li><a href="/category/ai-yolo.html">AI, yolo</a></li>
											<li><a href="/category/an-quan.html">安全</a></li>
											<li><a href="/category/ban-ben-kong-zhi.html">版本控制</a></li>
									</ul>
								</section>
							</div>

							<div class="4u">
								<section>
									<header>
										<h2>SITEMAP</h2>
									</header>

									<ul class="divided">
												<li><a href="/authors.html">作者</a></li>
												<li><a href="/categories.html">分类</a></li>
												<li><a href="/archives.html">归档</a></li>
												<li><a href="/tags.html">标签</a></li>
									</ul>
								</section>
							</div>

							<div class="4u">

								<section>
									<header>
										<h2>Contact</h2>
									</header>
									<ul class="social">
									</ul>
								</section>
							</div>
						</div>
						<div class="row">
							<div class="12u">
								<!-- Copyright -->
									<div id="copyright">
										<ul class="links">
											<li>&copy; YanQue 2019-2024	</li>
											<!-- <li>Images: <a href="http://facebook.com/DreametryDoodle">Dreametry Doodle</a> + <a href="http://iconify.it">Iconify.it</a></li>
											<li>Design: <a href="http://html5up.net">HTML5 UP</a></li> -->
										</ul>
									</div>
							</div>
						</div>
					</section>
			</div>

		</div>

		<!-- 其他 -->

			<div style="position: fixed;">
				<!-- 深色模式粒子效果 -->
				<!-- <canvas id="universe" width="1428" height="993" data-relingo-block="true" data-relingo-parsed="true"></canvas> -->
				<!-- 深色模式下添加粒子效果canvas -->
				<canvas id="universe" width="1312" height="880"></canvas>
			</div>

		<script src="/theme//js/jquery-3.7.1.min.js"></script>
		<script src="/theme//js/jquery.dropotron.js"></script>

		<script src="/theme//js/config.js"></script>
		<script src="/theme//js/backloading.js"></script>

		<script src="/theme//skel-s0.4.8/skel.min.js"></script>
		<script src="/theme//skel-s0.4.8/skel-panels.min.js"></script>
		<!-- <script src="/theme/js/skel.min.js"></script>
		<script src="/theme/js/skel-panels.min.js"></script> -->
		<script src="/theme//js/canvas/dark.js"></script>
		<script src="/theme//js/yq-blog-plugin.min.js"></script>
<script type="text/javascript">
	function addEvent() {
		$("#toc-contents-title-text").click(function() {
			$("#top-toc-tree-container").toggleClass("no-active");
			$("#sidebar-tools").toggleClass("no-active");
		})
		$("#sidebar-tools").click(function() {
			$("#top-toc-tree-container").toggleClass("no-active");
			$("#sidebar-tools").toggleClass("no-active");
		})
		$("#sidebar-tool-back-top").click(function() {
			// window.scrollTo(0, 0);
			window.scrollTo({
				top: 0,
				left: 0,
				behavior: 'smooth'
			});
		})
	}
	addEvent()
</script>
		<!--[if lte IE 8]><script src="js/html5shiv.js"></script><link rel="stylesheet" href="/theme/css/ie8.css" /><![endif]-->
	</body>
</html>